<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM Perangkat Ajar Kurikulum Merdeka</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background-color: #1a252f; color: white; padding-top: 20px;}
        .sidebar .nav-link { color: #bdc3c7; cursor: pointer; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #2c3e50; border-radius: 5px; }
        .content-area { padding: 20px; height: 100vh; overflow-y: auto; }
        
        /* Document Styles */
        .document-page { background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; font-family: 'Times New Roman', Times, serif; color: black; max-width: 100%; overflow-x: auto;}
        .doc-header { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 15px; text-transform: uppercase; line-height: 1.3; }
        table.doc-table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-bottom: 15px; }
        table.doc-table th, table.doc-table td { border: 1px solid black; padding: 8px; vertical-align: middle; }
        table.doc-table th { background-color: #f8f9fa; text-align: center; font-weight: bold; }
        table.identity-table { width: 100%; margin-bottom: 15px; font-size: 11pt; }
        table.identity-table td { padding: 4px; vertical-align: top; }
        
        .signature-area { width: 100%; margin-top: 40px; display: table; page-break-inside: avoid; }
        .signature-box { display: table-cell; width: 50%; text-align: center; font-size: 11pt; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 75px; }

        /* Print Settings (Fixing Blank Pages) */
        @media print {
            @page { margin: 15mm; }
            body { background-color: white !important; margin: 0; padding: 0; }
            .no-print, .sidebar { display: none !important; }
            .content-area { width: 100% !important; padding: 0 !important; overflow: visible !important; height: auto !important; }
            .document-page { box-shadow: none !important; margin: 0 !important; padding: 0 !important; border: none !important; }
            .hide-on-print { display: none !important; }
            table.doc-table th { -webkit-print-color-adjust: exact; background-color: #e9ecef !important; }
            
            .landscape-print { @page { size: landscape; } }
            .portrait-print { @page { size: portrait; } }
        }
    </style>
</head>
<body>

    <div id="mainApp" class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar flex-column no-print">
                <div class="text-center mb-3">
                    <img id="userAvatar" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" class="rounded-circle mb-2 bg-secondary" width="50" height="50">
                    <div id="userName" class="small fw-bold">Guru Universal</div>
                </div>
                <hr class="bg-light">
                <nav class="nav flex-column">
                    <a class="nav-link active" onclick="showTab('tabDashboard')">üè† Dashboard</a>
                    <a class="nav-link text-warning" onclick="showTab('tabProfil')">üè´ Profil & Mapel</a>
                    <a class="nav-link text-info" onclick="showTab('tabCPTP')">üéØ Setup CP & TP</a>
                    <a class="nav-link" onclick="showTab('tabSiswa')">üë• Data Siswa (CSV)</a>
                    <a class="nav-link" onclick="showTab('tabJadwal')">üìÖ Jadwal Mengajar</a>
                    <a class="nav-link" onclick="showTab('tabTahunan')">üìÅ Prota, Promes, ATP</a>
                    <a class="nav-link" onclick="showTab('tabPerangkat')">üìñ Modul & LKPD</a>
                    <a class="nav-link" onclick="showTab('tabPelaksanaan')">üìã Absen & Jurnal</a>
                    <a class="nav-link" onclick="showTab('tabPenilaian')">üìà Rekap Penilaian</a>
                </nav>
            </div>

            <div class="col-md-10 content-area" id="mainContentArea">
                
                <div id="tabDashboard" class="tab-content">
                    <h3 class="mb-4">Sistem Manajemen Kurikulum Merdeka</h3>
                    <div class="alert alert-success shadow-sm">
                        <h5>üåü Aplikasi Kini Mendukung Semua Mapel!</h5>
                        <p>1. Buka <b>Profil & Mapel</b> untuk mengatur Identitas Sekolah dan Nama Mata Pelajaran.<br>
                        2. Buka <b>Setup CP & TP</b> untuk memasukkan target pembelajaran spesifik mata pelajaran Anda.<br>
                        3. Buka <b>Data Siswa</b> untuk mengimpor CSV. Header kolom sekarang wajib: <code>nisn, nama, jk, kelas, rombel</code>.</p>
                    </div>
                </div>

                <div id="tabProfil" class="tab-content d-none no-print">
                    <h3 class="mb-3">Profil Instansi & Guru</h3>
                    <div class="card p-4 shadow-sm border-warning">
                        <div class="row g-3">
                            <div class="col-md-4"><label class="fw-bold small">Mata Pelajaran <span class="text-danger">*</span></label><input type="text" id="profMapel" class="form-control" placeholder="Contoh: Matematika / PAI / IPA"></div>
                            <div class="col-md-4"><label class="fw-bold small">NPSN Sekolah</label><input type="number" id="profNpsn" class="form-control" placeholder="12345678"></div>
                            <div class="col-md-4"><label class="fw-bold small">Nama Sekolah</label><input type="text" id="profSekolah" class="form-control" placeholder="SDN 1 ..."></div>
                            <div class="col-md-6"><label class="fw-bold small">Kepala Sekolah</label><input type="text" id="profKepsek" class="form-control"></div>
                            <div class="col-md-6"><label class="fw-bold small">NIP Kepsek</label><input type="text" id="profNipKepsek" class="form-control"></div>
                            <div class="col-md-4"><label class="fw-bold small">Nama Guru Pengampu</label><input type="text" id="profGuru" class="form-control"></div>
                            <div class="col-md-4"><label class="fw-bold small">NIP Guru</label><input type="text" id="profNipGuru" class="form-control"></div>
                            <div class="col-md-4"><label class="fw-bold small">Tahun Ajaran</label><input type="text" id="profTahun" class="form-control" value="2025/2026"></div>
                            <div class="col-md-12"><label class="fw-bold small">Tempat, Tgl Pengesahan Dokumen</label><input type="text" id="profTanggal" class="form-control" placeholder="Jakarta, 15 Juli 2025"></div>
                            <div class="col-md-12 mt-3"><button class="btn btn-warning fw-bold" onclick="simpanProfil()">üíæ Simpan Profil</button></div>
                        </div>
                    </div>
                </div>

                <div id="tabCPTP" class="tab-content d-none no-print">
                    <h3 class="mb-3">Setup Capaian & Tujuan Pembelajaran</h3>
                    <div class="card p-4 shadow-sm border-info">
                        <div class="mb-3">
                            <label class="fw-bold">Capaian Pembelajaran (CP) Keseluruhan Fase:</label>
                            <textarea id="inputCP" class="form-control" rows="3" placeholder="Masukkan narasi CP sesuai SK BSKAP terbaru..."></textarea>
                        </div>
                        <hr>
                        <label class="fw-bold mb-2">Daftar Tujuan Pembelajaran (TP) / Materi Per Bab:</label>
                        <table class="table table-bordered">
                            <thead class="table-light"><tr><th width="10%">Bab Ke-</th><th width="75%">Tujuan Pembelajaran (Topik Materi)</th><th width="15%">Alokasi JP</th></tr></thead>
                            <tbody id="bodyInputTP"></tbody>
                        </table>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-primary btn-sm" onclick="tambahBarisTP()">‚ûï Tambah Bab/Materi</button>
                            <button class="btn btn-info fw-bold" onclick="simpanCPTP()">üíæ Simpan Data CP & TP</button>
                        </div>
                    </div>
                </div>

                <div id="tabSiswa" class="tab-content d-none no-print">
                    <h3 class="mb-3">Import Data Siswa Terintegrasi</h3>
                    <div class="alert alert-info small">
                        Pastikan file CSV memiliki Header (baris pertama) persis seperti ini: <b>nisn, nama, jk, kelas, rombel</b>. Sistem akan otomatis memfilter rombel.
                    </div>
                    <div class="card p-3 mb-4 shadow-sm border-primary">
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h6>Opsi 1: Link CSV Online (Google Sheets)</h6>
                                <input type="url" id="inputCsvUrl" class="form-control mb-2" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv">
                                <button class="btn btn-outline-primary w-100" onclick="importSiswaUrl()">üåê Tarik Data dari Link</button>
                            </div>
                            <div class="col-md-6">
                                <h6>Opsi 2: Upload File .CSV Lokal</h6>
                                <input type="file" id="fileCsvSiswa" class="form-control mb-2" accept=".csv">
                                <button class="btn btn-outline-secondary w-100" onclick="importSiswaLokal()">üìÅ Upload File CSV</button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <select id="filterKelasSiswa" class="form-select w-25" onchange="renderTabelSiswa()"></select>
                        <button class="btn btn-danger btn-sm" onclick="clearDataSiswa()">Hapus Semua Siswa</button>
                    </div>
                    <table class="table table-bordered bg-white shadow-sm">
                        <thead class="table-dark"><tr><th>NISN</th><th>Nama Siswa</th><th>JK</th><th>Kelas</th><th>Rombel</th></tr></thead>
                        <tbody id="tabelSiswaBody"></tbody>
                    </table>
                </div>

                <div id="tabJadwal" class="tab-content d-none no-print">
                    <h3 class="mb-3">Jadwal Mengajar Anda</h3>
                    <div class="card p-3 shadow-sm mb-3">
                        <div class="row g-2">
                            <div class="col-md-2"><select id="jadwalHari" class="form-select"><option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option></select></div>
                            <div class="col-md-2"><input type="number" id="jadwalJam" class="form-control" placeholder="Jam Ke-"></div>
                            <div class="col-md-3"><select id="jadwalFase" class="form-select"><option value="A">Fase A</option><option value="B">Fase B</option><option value="C">Fase C</option><option value="D">Fase D (SMP)</option><option value="E">Fase E (SMA)</option><option value="F">Fase F (SMA)</option></select></div>
                            <div class="col-md-3"><input type="text" id="jadwalRombel" class="form-control" placeholder="Rombel (Cth: 7A)"></div>
                            <div class="col-md-2"><button class="btn btn-success w-100" onclick="tambahJadwalLokal()">Tambah</button></div>
                        </div>
                    </div>
                    <table class="table table-striped bg-white shadow-sm"><thead class="table-dark"><tr><th>Hari</th><th>Jam</th><th>Fase</th><th>Rombel</th><th>Aksi</th></tr></thead><tbody id="tabelJadwalBody"></tbody></table>
                </div>

                <div id="tabTahunan" class="tab-content d-none">
                     <div class="no-print card p-3 shadow-sm mb-3 border-primary">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Pilih Fase & Rombel</label><select id="tFaseRombel" class="form-select"></select></div>
                            <div class="col-md-2"><button class="btn btn-primary w-100" onclick="generateTahunan()">Load Data</button></div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-danger" onclick="triggerPrint('docATP', 'ATP', 'landscape')">Cetak ATP</button>
                                <button class="btn btn-danger" onclick="triggerPrint('docProta', 'Prota', 'portrait')">Cetak Prota</button>
                                <button class="btn btn-danger" onclick="triggerPrint('docPromes', 'Promes', 'landscape')">Cetak Promes</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="docATP" class="document-page print-view d-none">
                        <div class="doc-header">ALUR TUJUAN PEMBELAJARAN (ATP)</div>
                        <table class="identity-table mb-3"><tr><td width="15%">Sekolah</td><td>:</td><td class="vSekolah"></td><td width="15%">Mata Pelajaran</td><td>:</td><td class="vMapel"></td></tr><tr><td>Fase / Rombel</td><td>:</td><td class="vFaseRombel"></td><td>Tahun Ajaran</td><td>:</td><td class="vTahun"></td></tr></table>
                        <div class="mb-2"><b>Capaian Pembelajaran:</b> <span id="vCPATP"></span></div>
                        <table class="doc-table"><tr><th width="10%">Bab</th><th width="75%">Alur Tujuan Pembelajaran (Materi)</th><th width="15%">Alokasi JP</th></tr><tbody id="tblAtpBody"></tbody></table>
                        <div class="signature-area"><div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div>NIP. <span class="vNipKepsek"></span></div><div class="signature-box"><span class="vTanggal"></span><br>Guru <span class="vMapel"></span><div class="signature-name vGuru"></div>NIP. <span class="vNipGuru"></span></div></div>
                    </div>

                    <div id="docProta" class="document-page print-view d-none">
                        <div class="doc-header">PROGRAM TAHUNAN (PROTA)</div>
                        <table class="identity-table mb-3"><tr><td width="15%">Mata Pelajaran</td><td>:</td><td class="vMapel"></td><td width="15%">Fase/Rombel</td><td>:</td><td class="vFaseRombel"></td></tr></table>
                        <table class="doc-table"><tr><th>Semester</th><th>Bab / Tujuan Pembelajaran</th><th>Alokasi JP</th><th>Keterangan</th></tr><tbody id="tblProtaBody"></tbody></table>
                        <div class="signature-area"><div class="signature-box">Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box">Guru <span class="vMapel"></span><div class="signature-name vGuru"></div></div></div>
                    </div>

                    <div id="docPromes" class="document-page print-view d-none">
                        <div class="doc-header">PROGRAM SEMESTER (PROMES)</div>
                        <table class="identity-table mb-2"><tr><td width="10%">Sekolah</td><td>:</td><td class="vSekolah"></td><td width="10%">Mapel</td><td>:</td><td class="vMapel"></td></tr></table>
                        <table class="doc-table" style="font-size: 9pt;"><tr><th rowspan="2">Tujuan Pembelajaran / Materi</th><th rowspan="2">JP</th><th colspan="4">Juli</th><th colspan="4">Agustus</th><th colspan="4">September</th><th colspan="4">Oktober</th></tr><tr><th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th></tr><tbody id="tblPromesBody"></tbody></table>
                        <div class="signature-area mt-4"><div class="signature-box">Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box">Guru <span class="vMapel"></span><div class="signature-name vGuru"></div></div></div>
                    </div>
                    
                    <div id="previewTahunan" class="alert alert-secondary text-center no-print">Tekan "Load Data" untuk mengaktifkan cetak ATP, Prota, dan Promes.</div>
                </div>

                <div id="tabPerangkat" class="tab-content d-none">
                     <div class="no-print card p-3 shadow-sm mb-3 border-success">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Jadwal Mengajar</label><select id="pSelectJadwal" class="form-select"></select></div>
                            <div class="col-md-4"><label class="small fw-bold">Pilih Materi (Sesuai TP)</label><select id="pSelectTP" class="form-select"></select></div>
                            <div class="col-md-2"><button class="btn btn-success w-100" onclick="generateModul()">Buat Data</button></div>
                            <div class="col-md-2"><button class="btn btn-danger w-100" onclick="triggerPrint('docModul', 'Modul', 'portrait')">Cetak Modul</button></div>
                        </div>
                    </div>
                    <div id="docModul" class="document-page print-view d-none">
                        <div class="doc-header">MODUL AJAR KURIKULUM MERDEKA</div>
                        <b>A. INFORMASI UMUM</b>
                        <table class="identity-table mt-2 mb-3">
                            <tr><td width="20%">Penyusun</td><td>:</td><td class="vGuru fw-bold"></td><td width="15%">Instansi</td><td>:</td><td class="vSekolah"></td></tr>
                            <tr><td>Mata Pelajaran</td><td>:</td><td class="vMapel"></td><td>Fase / Rombel</td><td>:</td><td><span class="vFaseRombel"></span></td></tr>
                        </table>
                        <b>B. CAPAIAN & TUJUAN PEMBELAJARAN</b>
                        <p class="mb-3 text-justify">Peserta didik mampu memahami dan menguasai materi tentang: <b><span id="outMateriModul">...</span></b>.</p>
                        <b>C. KEGIATAN PEMBELAJARAN</b>
                        <table class="doc-table mt-2">
                            <tr><th width="20%">Tahap</th><th>Deskripsi Kegiatan</th></tr>
                            <tr><td><b>Pendahuluan</b></td><td>1. Berdoa.<br>2. Cek kebersihan dan presensi.<br>3. Apersepsi materi.</td></tr>
                            <tr><td><b>Inti</b></td><td>1. Penjelasan materi.<br>2. Diskusi kelompok peserta didik.<br>3. Presentasi dan pengerjaan LKPD.</td></tr>
                            <tr><td><b>Penutup</b></td><td>1. Kesimpulan bersama.<br>2. Doa penutup.</td></tr>
                        </table>
                        <div class="signature-area"><div class="signature-box">Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box">Guru <span class="vMapel"></span><div class="signature-name vGuru"></div></div></div>
                    </div>
                </div>

                <div id="tabPelaksanaan" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-danger">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Jadwal Hari Ini</label><select id="selectJadwalAbsen" class="form-select"></select></div>
                            <div class="col-md-4"><label class="small fw-bold">Pilih Materi (TP)</label><select id="selectTPAbsen" class="form-select"></select></div>
                            <div class="col-md-2"><button class="btn btn-danger w-100" onclick="loadAbsensi()">Mulai Absen</button></div>
                            <div class="col-md-2 text-end"><button class="btn btn-outline-danger w-100" onclick="triggerPrint('docJurnal', 'Jurnal', 'landscape')">Cetak Jurnal</button></div>
                        </div>
                    </div>
                    <div id="areaAbsen" class="d-none no-print mb-4 p-3 bg-white border rounded shadow-sm">
                        <div id="listSiswaAbsen" class="row mt-2"></div><button class="btn btn-primary mt-3" onclick="simpanJurnal()">Simpan ke Jurnal</button>
                    </div>
                    <div id="docJurnal" class="document-page print-view d-none">
                        <div class="doc-header">JURNAL PELAKSANAAN PEMBELAJARAN</div>
                        <table class="identity-table" style="width: 50%;"><tr><td width="30%">Nama Sekolah</td><td>:</td><td class="vSekolah fw-bold"></td></tr><tr><td>Mata Pelajaran</td><td>:</td><td class="vMapel"></td></tr><tr><td>Nama Guru</td><td>:</td><td class="vGuru"></td></tr></table>
                        <table class="doc-table mt-2 text-center">
                            <thead><tr><th width="15%">Hari/Tgl</th><th width="10%">Rombel</th><th width="35%">Materi / Tujuan Pembelajaran</th><th width="20%">Absensi Siswa</th><th width="20%">Catatan Guru</th></tr></thead>
                            <tbody><tr><td id="jurTanggal"></td><td id="jurRombel"></td><td id="jurMateri" class="text-start"></td><td class="text-start">Hadir: <span id="jurHadir">0</span><br>Absen: <span id="jurAbsen">0</span><br><div id="jurListAbsen" class="small"></div></td><td>Tuntas</td></tr></tbody>
                        </table>
                        <div class="signature-area mt-4"><div class="signature-box">Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box">Guru <span class="vMapel"></span><div class="signature-name vGuru"></div></div></div>
                    </div>
                </div>

                <div id="tabPenilaian" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-info">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Pilih Rombel</label><select id="selectKelasNilai" class="form-select" onchange="loadPenilaian()"></select></div>
                            <div class="col-md-4"><label class="small fw-bold">Topik / Bab Penilaian</label><input type="text" id="topikNilai" class="form-control" value="Ulangan Harian"></div>
                            <div class="col-md-2"><button class="btn btn-info w-100" onclick="simpanNilai()">Simpan</button></div>
                            <div class="col-md-2 text-end"><button class="btn btn-outline-danger w-100" onclick="triggerPrint('docNilai', 'Nilai', 'portrait')">Cetak Nilai</button></div>
                        </div>
                    </div>
                    
                    <div id="docNilai" class="document-page print-view d-none">
                        <div class="doc-header">REKAPITULASI NILAI SISWA</div>
                        <table class="identity-table" style="width: 60%;">
                            <tr><td width="25%">Mata Pelajaran</td><td>:</td><td class="vMapel"></td></tr>
                            <tr><td>Rombel</td><td>:</td><td><b id="lblKelasNilai">...</b></td></tr>
                            <tr><td>Topik Penilaian</td><td>:</td><td><b id="lblTopikNilai">...</b></td></tr>
                        </table>
                        <table class="doc-table mt-3 text-center">
                            <thead><tr><th width="5%">No</th><th width="15%">NISN</th><th width="50%" class="text-start">Nama Siswa</th><th width="10%">JK</th><th width="20%">Nilai</th></tr></thead>
                            <tbody id="tblNilaiBody"><tr><td colspan="5">Pilih Rombel.</td></tr></tbody>
                        </table>
                        <div class="signature-area"><div class="signature-box">Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box">Guru <span class="vMapel"></span><div class="signature-name vGuru"></div></div></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Data State
        let dataSiswa = JSON.parse(localStorage.getItem('sim_siswa')) || [];
        let dataJadwal = JSON.parse(localStorage.getItem('sim_jadwal')) || [];
        let dataNilai = JSON.parse(localStorage.getItem('sim_nilai')) || {};
        let dataCPTP = JSON.parse(localStorage.getItem('sim_cptp')) || { cp: "", tps: [{bab:1, judul:"Materi Pertama", jp:4}] };

        // Navigation
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.remove('d-none');
            event.target.classList.add('active');
            
            // Re-render specifics
            updateUIProfile();
            if(tabId === 'tabCPTP') renderCPTP();
            if(tabId === 'tabTahunan') populateFaseRombelOptions('tFaseRombel');
            if(tabId === 'tabPerangkat' || tabId === 'tabPelaksanaan') populateDropdowns();
            if(tabId === 'tabPenilaian') renderKelasPenilaian();
        };

        // Print Logic (Fixing Blank Pages)
        window.triggerPrint = function(sourceId, pdfName, orientation) {
            updateUIProfile();
            document.title = pdfName + "_" + new Date().getTime();
            
            document.body.classList.remove('landscape-print', 'portrait-print');
            document.body.classList.add(orientation + '-print');
            
            // Hide all pages, show target
            document.querySelectorAll('.print-view').forEach(el => el.classList.add('hide-on-print'));
            document.querySelectorAll('.document-page').forEach(el => el.style.display = 'none');
            
            const target = document.getElementById(sourceId);
            target.classList.remove('d-none', 'hide-on-print');
            target.style.display = 'block';
            
            window.print();
            
            target.style.display = 'none';
        };

        // 1. PROFIL
        window.simpanProfil = function() {
            const p = { 
                mapel: document.getElementById('profMapel').value,
                npsn: document.getElementById('profNpsn').value, 
                sek: document.getElementById('profSekolah').value, 
                thn: document.getElementById('profTahun').value, 
                kep: document.getElementById('profKepsek').value, 
                nkep: document.getElementById('profNipKepsek').value, 
                gur: document.getElementById('profGuru').value, 
                ngur: document.getElementById('profNipGuru').value, 
                tgl: document.getElementById('profTanggal').value 
            };
            if(!p.mapel) return alert("Mata Pelajaran Wajib Diisi!");
            localStorage.setItem('sim_prof', JSON.stringify(p)); alert("Profil Tersimpan!"); updateUIProfile();
        };

        function loadProfil() {
            const p = JSON.parse(localStorage.getItem('sim_prof'));
            if(p) { 
                document.getElementById('profMapel').value = p.mapel||''; document.getElementById('profNpsn').value = p.npsn||''; document.getElementById('profSekolah').value = p.sek||''; document.getElementById('profTahun').value = p.thn||''; document.getElementById('profKepsek').value = p.kep||''; document.getElementById('profNipKepsek').value = p.nkep||''; document.getElementById('profGuru').value = p.gur||''; document.getElementById('profNipGuru').value = p.ngur||''; document.getElementById('profTanggal').value = p.tgl||''; 
            }
            updateUIProfile();
        }

        function updateUIProfile() {
            const p = JSON.parse(localStorage.getItem('sim_prof')) || {};
            document.querySelectorAll('.vMapel').forEach(e => e.innerText = p.mapel || 'Mata Pelajaran');
            document.querySelectorAll('.vSekolah').forEach(e => e.innerText = p.sek || '...');
            document.querySelectorAll('.vTahun').forEach(e => e.innerText = p.thn || '...');
            document.querySelectorAll('.vKepsek').forEach(e => e.innerText = p.kep || '...');
            document.querySelectorAll('.vNipKepsek').forEach(e => e.innerText = p.nkep || '...');
            document.querySelectorAll('.vGuru').forEach(e => e.innerText = p.gur || '...');
            document.querySelectorAll('.vNipGuru').forEach(e => e.innerText = p.ngur || '...');
            document.querySelectorAll('.vTanggal').forEach(e => e.innerText = p.tgl || '...');
        }

        // 2. SETUP CP & TP
        function renderCPTP() {
            document.getElementById('inputCP').value = dataCPTP.cp;
            let h = '';
            dataCPTP.tps.forEach((tp, i) => {
                h += `<tr>
                    <td><input type="number" class="form-control tp-bab" value="${tp.bab}"></td>
                    <td><input type="text" class="form-control tp-judul" value="${tp.judul}"></td>
                    <td><input type="number" class="form-control tp-jp" value="${tp.jp}"></td>
                </tr>`;
            });
            document.getElementById('bodyInputTP').innerHTML = h;
        }

        window.tambahBarisTP = function() {
            dataCPTP.tps.push({ bab: dataCPTP.tps.length+1, judul: "", jp: 4 });
            renderCPTP();
        }

        window.simpanCPTP = function() {
            dataCPTP.cp = document.getElementById('inputCP').value;
            dataCPTP.tps = [];
            const babs = document.querySelectorAll('.tp-bab');
            const juduls = document.querySelectorAll('.tp-judul');
            const jps = document.querySelectorAll('.tp-jp');
            for(let i=0; i<babs.length; i++){
                if(juduls[i].value.trim() !== "") {
                    dataCPTP.tps.push({ bab: babs[i].value, judul: juduls[i].value, jp: jps[i].value });
                }
            }
            localStorage.setItem('sim_cptp', JSON.stringify(dataCPTP));
            alert("Data CP & TP Berhasil Disimpan!");
        }

        // 3. IMPORT SISWA
        function processCsvData(d) {
            let hitung = 0;
            d.forEach(s => {
                // Get properties regardless of case
                let kls = s.kelas||s.Kelas||s.KELAS;
                let rmb = s.rombel||s.Rombel||s.ROMBEL;
                let nm = s.nama||s.Nama||s.NAMA;
                if(nm && kls && rmb) {
                    dataSiswa.push({ 
                        nisn: s.nisn||s.NISN||s.Nisn||'-', 
                        nama: nm, 
                        jk: s.jk||s.JK||s.Jk||'-', 
                        kelas: kls, 
                        rombel: rmb 
                    });
                    hitung++;
                }
            });
            localStorage.setItem('sim_siswa', JSON.stringify(dataSiswa));
            renderTabelSiswa(); alert(`${hitung} data siswa ter-import!`);
        }

        window.importSiswaLokal = function() {
            const f = document.getElementById('fileCsvSiswa').files[0];
            if(!f) return alert("Pilih file!");
            Papa.parse(f, { header: true, skipEmptyLines: true, complete: function(r) { processCsvData(r.data); }});
        };
        window.importSiswaUrl = function() {
            const u = document.getElementById('inputCsvUrl').value;
            if(!u) return alert("Isi URL!");
            Papa.parse(u, { download: true, header: true, skipEmptyLines: true, complete: function(r) { processCsvData(r.data); }});
        };
        window.clearDataSiswa = function() { if(confirm("Hapus semua?")){ dataSiswa=[]; localStorage.removeItem('sim_siswa'); renderTabelSiswa();} }
        
        window.renderTabelSiswa = function() {
            const f = document.getElementById('filterKelasSiswa').value;
            let opt = '<option value="ALL">-- Semua Rombel --</option>';
            new Set(dataSiswa.map(s => s.rombel)).forEach(r => opt += `<option value="${r}" ${f===r?'selected':''}>${r}</option>`);
            document.getElementById('filterKelasSiswa').innerHTML = opt;
            
            let tb = ''; (f==="ALL"?dataSiswa:dataSiswa.filter(s=>s.rombel===f)).forEach(s => tb += `<tr><td>${s.nisn}</td><td>${s.nama}</td><td>${s.jk}</td><td>${s.kelas}</td><td>${s.rombel}</td></tr>`);
            document.getElementById('tabelSiswaBody').innerHTML = tb || '<tr><td colspan="5" class="text-center">Kosong</td></tr>';
        };

        // 4. JADWAL (Lokal, No Firebase for reliability based on user error context)
        window.tambahJadwalLokal = function() {
            const h = document.getElementById('jadwalHari').value, j = document.getElementById('jadwalJam').value, f = document.getElementById('jadwalFase').value, r = document.getElementById('jadwalRombel').value;
            if(!j || !r) return alert("Jam & Rombel wajib isi!");
            dataJadwal.push({ hari:h, jam:j, fase:f, rombel:r });
            localStorage.setItem('sim_jadwal', JSON.stringify(dataJadwal));
            renderJadwal(); document.getElementById('jadwalJam').value=''; document.getElementById('jadwalRombel').value='';
        }
        window.hapusJadwal = function(idx) { dataJadwal.splice(idx,1); localStorage.setItem('sim_jadwal', JSON.stringify(dataJadwal)); renderJadwal(); }
        
        function renderJadwal() {
            let tb = ''; dataJadwal.forEach((d,i) => tb+=`<tr><td>${d.hari}</td><td>Ke-${d.jam}</td><td>${d.fase}</td><td>${d.rombel}</td><td><button class="btn btn-sm btn-danger" onclick="hapusJadwal(${i})">Hapus</button></td></tr>`);
            document.getElementById('tabelJadwalBody').innerHTML = tb;
        }

        function populateDropdowns() {
            let oj = '<option value="">-- Pilih Jadwal/Rombel --</option>';
            dataJadwal.forEach((d,i) => oj += `<option value='${JSON.stringify(d)}'>${d.hari} Jam ${d.jam} - Rombel ${d.rombel}</option>`);
            document.querySelectorAll('#pSelectJadwal, #selectJadwalAbsen').forEach(el => el.innerHTML = oj);

            let ot = '<option value="">-- Pilih Materi (TP) --</option>';
            dataCPTP.tps.forEach(t => ot += `<option value='${t.judul}'>Bab ${t.bab} - ${t.judul}</option>`);
            document.querySelectorAll('#pSelectTP, #selectTPAbsen').forEach(el => el.innerHTML = ot);
        }

        function populateFaseRombelOptions(elementId) {
            let setFr = new Set(dataJadwal.map(d => `Fase ${d.fase} - ${d.rombel}`));
            let o = ''; setFr.forEach(fr => o += `<option value="${fr}">${fr}</option>`);
            document.getElementById(elementId).innerHTML = o || '<option value="">Buat Jadwal Dulu</option>';
        }

        // 5. GENERATOR DOKUMEN
        window.generateTahunan = function() {
            const fr = document.getElementById('tFaseRombel').value;
            document.querySelectorAll('.vFaseRombel').forEach(el => el.innerText = fr);
            document.getElementById('vCPATP').innerText = dataCPTP.cp;

            let hatp='', hprota='', hpromes='';
            dataCPTP.tps.forEach(t => {
                hatp += `<tr><td>${t.bab}</td><td>Peserta didik mampu memahami: ${t.judul}</td><td>${t.jp} JP</td></tr>`;
                hprota += `<tr><td>Ganjil</td><td>Bab ${t.bab} - ${t.judul}</td><td>${t.jp}</td><td>Dilaksanakan Sesuai Kalender</td></tr>`;
                hpromes += `<tr><td>Bab ${t.bab}: ${t.judul}</td><td>${t.jp}</td><td>${Math.ceil(t.jp/2)}</td><td>${Math.floor(t.jp/2)}</td><td></td><td></td> <td></td><td></td><td></td><td></td> <td></td><td></td><td></td><td></td> <td></td><td></td><td></td><td></td></tr>`;
            });
            document.getElementById('tblAtpBody').innerHTML = hatp;
            document.getElementById('tblProtaBody').innerHTML = hprota;
            document.getElementById('tblPromesBody').innerHTML = hpromes;

            document.getElementById('previewTahunan').classList.add('d-none');
            document.getElementById('docATP').classList.remove('d-none');
        }

        window.generateModul = function() {
            const j = document.getElementById('pSelectJadwal').value; const tp = document.getElementById('pSelectTP').value;
            if(!j || !tp) return alert("Pilih Jadwal & Materi!");
            const jv = JSON.parse(j);
            document.querySelectorAll('.vFaseRombel').forEach(e => e.innerText = `Fase ${jv.fase} / ${jv.rombel}`);
            document.getElementById('outMateriModul').innerText = tp;
            document.getElementById('docModul').classList.remove('d-none');
            alert("Modul Dibuat! Silakan Cetak.");
        }

        // 6. ABSENSI
        window.loadAbsensi = function() {
            const jVal = document.getElementById('selectJadwalAbsen').value; if(!jVal) return alert("Pilih Jadwal!");
            const rmb = JSON.parse(jVal).rombel; const sKelas = dataSiswa.filter(s => s.rombel === rmb);
            document.getElementById('areaAbsen').classList.remove('d-none');
            let h = ''; sKelas.forEach(s => h += `<div class="col-3"><input type="checkbox" class="absen-check" value="${s.nama}" checked> <span class="small">${s.nama}</span></div>`);
            document.getElementById('listSiswaAbsen').innerHTML = h || '<div class="text-danger">Siswa kosong di rombel ini.</div>';
        };

        window.simpanJurnal = function() {
            const jVal = JSON.parse(document.getElementById('selectJadwalAbsen').value);
            const mt = document.getElementById('selectTPAbsen').value;
            const boxes = document.querySelectorAll('.absen-check'); let h=0, abs=[];
            boxes.forEach(b => { if(b.checked) h++; else abs.push(b.value); });
            
            document.getElementById('jurTanggal').innerText = new Date().toLocaleDateString('id-ID');
            document.getElementById('jurRombel').innerText = jVal.rombel;
            document.getElementById('jurMateri').innerText = mt;
            document.getElementById('jurHadir').innerText = h; document.getElementById('jurAbsen').innerText = abs.length;
            document.getElementById('jurListAbsen').innerText = abs.length > 0 ? abs.join(", ") : "-";
            
            document.getElementById('docJurnal').classList.remove('d-none');
            alert("Tersimpan ke Jurnal! Silakan Cetak PDF.");
        };

        // 7. PENILAIAN
        window.renderKelasPenilaian = function() {
            let o = '<option value="">-- Pilih Rombel --</option>';
            new Set(dataSiswa.map(s => s.rombel)).forEach(k => o += `<option value="${k}">${k}</option>`);
            document.getElementById('selectKelasNilai').innerHTML = o;
        };

        window.loadPenilaian = function() {
            const rmb = document.getElementById('selectKelasNilai').value;
            document.getElementById('lblKelasNilai').innerText = rmb;
            document.getElementById('lblTopikNilai').innerText = document.getElementById('topikNilai').value;
            
            let tb = '';
            dataSiswa.filter(s => s.rombel === rmb).forEach((s, i) => {
                let v = dataNilai[`${rmb}_${s.nisn}`] || '';
                tb += `<tr><td>${i+1}</td><td>${s.nisn}</td><td class="text-start">${s.nama}</td><td>${s.jk}</td>
                <td class="no-print"><input type="number" class="form-control input-nilai text-center" data-id="${s.nisn}" value="${v}"></td>
                <td class="hide-on-print print-only-td" style="display:none;">${v}</td></tr>`;
            });
            tb += `<style>@media print { .input-nilai { display: none !important; } .print-only-td { display: table-cell !important; } }</style>`;
            document.getElementById('tblNilaiBody').innerHTML = tb || '<tr><td colspan="5">Pilih Rombel.</td></tr>';
            document.getElementById('docNilai').classList.remove('d-none');
        };

        window.simpanNilai = function() {
            const rmb = document.getElementById('selectKelasNilai').value; if(!rmb) return alert("Pilih rombel!");
            document.querySelectorAll('.input-nilai').forEach(el => dataNilai[`${rmb}_${el.getAttribute('data-id')}`] = el.value);
            localStorage.setItem('sim_nilai', JSON.stringify(dataNilai)); alert("Nilai Disimpan!"); loadPenilaian();
        };

        // Init
        window.onload = function() {
            loadProfil(); renderTabelSiswa(); renderJadwal(); renderCPTP();
        };
    </script>
</body>
</html>
