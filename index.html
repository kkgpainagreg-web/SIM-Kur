<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM PAI Terpadu Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background-color: #1a252f; color: white; padding-top: 20px;}
        .sidebar .nav-link { color: #bdc3c7; cursor: pointer; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #2c3e50; border-radius: 5px; }
        .content-area { padding: 20px; height: 100vh; overflow-y: auto; }
        
        /* Print Styles */
        .document-page { background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; font-family: 'Times New Roman', Times, serif; color: black; max-width: 100%; overflow-x: auto;}
        .doc-header { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 15px; text-transform: uppercase; line-height: 1.3; }
        table.doc-table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-bottom: 15px; }
        table.doc-table th, table.doc-table td { border: 1px solid black; padding: 8px; vertical-align: middle; }
        table.doc-table th { background-color: #f8f9fa; text-align: center; font-weight: bold; }
        table.identity-table { width: 100%; margin-bottom: 15px; font-size: 11pt; }
        table.identity-table td { padding: 4px; vertical-align: top; }
        
        .signature-area { width: 100%; margin-top: 40px; display: table; page-break-inside: avoid; }
        .signature-box { display: table-cell; width: 50%; text-align: center; font-size: 11pt; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 75px; }

        @media print {
            @page { margin: 15mm; }
            body { background-color: white; }
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .sidebar { display: none !important; }
            .content-area { width: 100% !important; height: auto !important; padding: 0 !important; overflow: visible !important; }
            .document-page { box-shadow: none; margin: 0; padding: 0; max-width: 100%; border: none; }
            .landscape-print { @page { size: landscape; } }
            .portrait-print { @page { size: portrait; } }
            table.doc-table th { -webkit-print-color-adjust: exact; background-color: #e9ecef !important; }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-5 text-center shadow" style="max-width: 450px;">
            <h3 class="mb-3 text-success fw-bold">üéì SIM PAI Terpadu</h3>
            <p class="text-muted small">Kelola Modul, Jadwal, Nilai & Absen Terintegrasi.</p>
            <button id="btnLogin" class="btn btn-danger mt-3">üåê Sign in with Google / belajar.id</button>
            <button class="btn btn-outline-secondary mt-3 btn-sm" onclick="bypassLogin()">Mode Uji Coba (Lokal)</button>
        </div>
    </div>

    <div id="mainApp" class="container-fluid d-none">
        <div class="row">
            <div class="col-md-2 sidebar flex-column no-print">
                <div class="text-center mb-3">
                    <img id="userAvatar" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" class="rounded-circle mb-2 bg-secondary" width="50" height="50" alt="User">
                    <div id="userName" class="small fw-bold"></div>
                    <button id="btnLogout" class="btn btn-sm btn-outline-light mt-2" style="font-size: 0.7rem;">Logout</button>
                </div>
                <hr class="bg-light">
                <nav class="nav flex-column">
                    <a class="nav-link active" onclick="showTab('tabDashboard')">üè† Dashboard</a>
                    <a class="nav-link" onclick="showTab('tabPanduan')">üìñ Panduan (Bantuan)</a>
                    <a class="nav-link text-warning" onclick="showTab('tabProfil')">üè´ Profil Instansi (NPSN)</a>
                    <a class="nav-link" onclick="showTab('tabSiswa')">üë• Data Siswa (CSV)</a>
                    <a class="nav-link" onclick="showTab('tabJadwal')">üìÖ Jadwal (Kolaborasi)</a>
                    <a class="nav-link" onclick="showTab('tabTahunan')">üìÅ Prota, Promes, ATP</a>
                    <a class="nav-link" onclick="showTab('tabPerangkat')">üìñ Modul & LKPD</a>
                    <a class="nav-link" onclick="showTab('tabPelaksanaan')">üìã Absen & Jurnal</a>
                    <a class="nav-link" onclick="showTab('tabPenilaian')">üìà Rekap Penilaian</a>
                </nav>
            </div>

            <div class="col-md-10 content-area" id="mainContentArea">
                
                <div id="tabDashboard" class="tab-content">
                    <h3 class="mb-4">Selamat Datang di SIM PAI Terpadu</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-success shadow-sm">
                                <h5>üåü Fitur Baru:</h5>
                                <ul>
                                    <li><b>Sistem NPSN Terpusat:</b> Jika guru lain di sekolah yang sama login, jadwal mengajar tidak akan bentrok satu sama lain.</li>
                                    <li><b>Import CSV Online:</b> Tarik data siswa langsung dari link Google Sheets tanpa download file.</li>
                                    <li><b>Penilaian Otomatis:</b> Modul nilai siap cetak berdasarkan kelas.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabPanduan" class="tab-content d-none no-print">
                    <h3 class="mb-3">Buku Panduan Penggunaan</h3>
                    <div class="card p-4 shadow-sm">
                        <ol style="line-height: 1.8;">
                            <li><b>Pengaturan Profil (Wajib):</b> Buka menu <i>Profil Instansi</i>. Isi data diri dan wajib isi <b>NPSN</b>. NPSN digunakan sistem untuk mengelompokkan guru dalam satu sekolah yang sama.</li>
                            <li><b>Input Data Siswa:</b> Buka menu <i>Data Siswa</i>. Ketik nama Kelas (Misal: 3A). Anda bisa upload file CSV lokal atau cukup *paste* link CSV (contoh link dari *Google Sheets -> File -> Share -> Publish to Web -> CSV*).</li>
                            <li><b>Pembuatan Jadwal:</b> Buka menu <i>Jadwal</i>. Tambahkan jam dan kelas. Sistem akan mengecek Database. Jika ada guru lain di sekolah Anda (NPSN sama) yang sudah mengajar di kelas/jam tersebut, sistem akan menolak jadwal Anda (Anti-Bentrok).</li>
                            <li><b>Perangkat Ajar:</b> Generate Prota/Promes dan Modul Ajar secara otomatis lalu cetak langsung ke format PDF dengan rapi.</li>
                            <li><b>Absen & Nilai:</b> Gunakan menu Absensi setiap selesai kelas untuk mencetak Jurnal. Gunakan menu <i>Penilaian</i> untuk merekap nilai ulangan/tugas harian.</li>
                        </ol>
                    </div>
                </div>

                <div id="tabProfil" class="tab-content d-none no-print">
                    <h3 class="mb-3">Profil Instansi & Guru</h3>
                    <div class="card p-4 shadow-sm border-warning">
                        <div class="alert alert-warning small"><b>Penting:</b> Pastikan NPSN diisi dengan benar. Sinkronisasi jadwal antar guru di sekolah Anda bergantung pada nomor NPSN ini.</div>
                        <div class="row g-3">
                            <div class="col-md-4"><label class="fw-bold small">NPSN Sekolah <span class="text-danger">*</span></label><input type="number" id="profNpsn" class="form-control" placeholder="12345678"></div>
                            <div class="col-md-4"><label class="fw-bold small">Nama Sekolah</label><input type="text" id="profSekolah" class="form-control" placeholder="SDN 1 ..."></div>
                            <div class="col-md-4"><label class="fw-bold small">Tahun Ajaran</label><input type="text" id="profTahun" class="form-control" value="2025/2026"></div>
                            <div class="col-md-6"><label class="fw-bold small">Kepala Sekolah</label><input type="text" id="profKepsek" class="form-control"></div>
                            <div class="col-md-6"><label class="fw-bold small">NIP Kepsek</label><input type="text" id="profNipKepsek" class="form-control"></div>
                            <div class="col-md-6"><label class="fw-bold small">Guru PAI</label><input type="text" id="profGuru" class="form-control"></div>
                            <div class="col-md-6"><label class="fw-bold small">NIP Guru</label><input type="text" id="profNipGuru" class="form-control"></div>
                            <div class="col-md-12"><label class="fw-bold small">Tempat, Tgl Pengesahan</label><input type="text" id="profTanggal" class="form-control" placeholder="Jakarta, 15 Juli 2025"></div>
                            <div class="col-md-12 mt-3"><button class="btn btn-success" onclick="simpanProfil()">üíæ Simpan Profil</button></div>
                        </div>
                    </div>
                </div>

                <div id="tabSiswa" class="tab-content d-none no-print">
                    <h3 class="mb-3">Import Data Siswa</h3>
                    <div class="card p-3 mb-4 shadow-sm border-primary">
                        <label class="fw-bold text-primary mb-2">Tujuan Kelas / Rombel: <input type="text" id="inputSiswaKelas" class="form-control w-25 d-inline" placeholder="Misal: Kelas 3A"></label>
                        
                        <div class="row mt-2 border-top pt-3">
                            <div class="col-md-6 border-end">
                                <h6>Opsi 1: Link CSV Online (Google Sheets)</h6>
                                <input type="url" id="inputCsvUrl" class="form-control mb-2" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv">
                                <button class="btn btn-outline-primary w-100" onclick="importSiswaUrl()">üåê Tarik Data dari Link</button>
                            </div>
                            <div class="col-md-6">
                                <h6>Opsi 2: Upload File .CSV Lokal</h6>
                                <input type="file" id="fileCsvSiswa" class="form-control mb-2" accept=".csv">
                                <button class="btn btn-outline-secondary w-100" onclick="importSiswaLokal()">üìÅ Upload File CSV</button>
                            </div>
                        </div>
                        <small class="text-muted mt-2"><i>*Format Kolom Header Wajib: <b>NIS, Nama, L/P</b></i></small>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <select id="filterKelasSiswa" class="form-select w-25" onchange="renderTabelSiswa()"></select>
                        <button class="btn btn-danger btn-sm" onclick="clearDataSiswa()">Hapus Semua Siswa</button>
                    </div>
                    <table class="table table-bordered bg-white shadow-sm"><thead class="table-dark"><tr><th>NIS</th><th>Nama Siswa</th><th>L/P</th><th>Kelas</th></tr></thead><tbody id="tabelSiswaBody"></tbody></table>
                </div>

                <div id="tabJadwal" class="tab-content d-none no-print">
                    <h3 class="mb-3">Jadwal Pelajaran Kolaboratif</h3>
                    <div class="alert alert-info py-2 small">Sistem melacak database menggunakan NPSN <b><span class="vNpsn">Belum diset</span></b>. Guru lain di instansi Anda akan tersinkronisasi.</div>
                    <div class="card p-3 shadow-sm mb-3">
                        <div class="row g-2">
                            <div class="col-md-2"><select id="jadwalHari" class="form-select"><option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option></select></div>
                            <div class="col-md-2"><input type="number" id="jadwalJam" class="form-control" placeholder="Jam Ke-"></div>
                            <div class="col-md-3"><input type="text" id="jadwalRombel" class="form-control" placeholder="Kelas (Misal: 3A)"></div>
                            <div class="col-md-3"><select id="jadwalFase" class="form-select"><option value="A">Fase A (Kls 1-2)</option><option value="B">Fase B (Kls 3-4)</option><option value="C">Fase C (Kls 5-6)</option></select></div>
                            <div class="col-md-2"><button class="btn btn-success w-100" id="btnTambahJadwal">Tambah</button></div>
                        </div>
                        <small class="text-danger mt-1 fw-bold" id="msgJadwal"></small>
                    </div>
                    <table class="table table-striped bg-white shadow-sm"><thead class="table-dark"><tr><th>Hari</th><th>Jam</th><th>Kelas</th><th>Fase</th><th>Aksi</th></tr></thead><tbody id="tabelJadwalBody"></tbody></table>
                </div>

                <div id="tabTahunan" class="tab-content d-none">
                     <div class="no-print card p-3 shadow-sm mb-3 border-primary">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3"><label class="small fw-bold">Pilih Fase & Kelas</label><select id="tFase" class="form-select"><option value="A">Fase A (Kelas 1)</option><option value="B">Fase B (Kelas 3)</option><option value="C">Fase C (Kelas 5)</option></select></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="generateTahunan()">Generate Dokumen</button></div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-danger" onclick="triggerPrint('docATP', 'ATP_PAI', 'portrait')">PDF ATP</button>
                                <button class="btn btn-outline-danger" onclick="triggerPrint('docProta', 'Prota_PAI', 'portrait')">PDF Prota</button>
                                <button class="btn btn-outline-danger" onclick="triggerPrint('docPromes', 'Promes_PAI', 'landscape')">PDF Promes</button>
                            </div>
                        </div>
                    </div>
                    <div id="docATP" class="document-page d-none"><div class="doc-header">ALUR TUJUAN PEMBELAJARAN (ATP)</div><table class="identity-table mb-3"><tr><td width="15%">Sekolah</td><td>:</td><td class="vSekolah"></td><td width="15%">Fase / Kelas</td><td>:</td><td class="vFaseKelas"></td></tr></table><table class="doc-table"><tr><th width="10%">Semester</th><th width="15%">Elemen</th><th width="60%">Tujuan Pembelajaran</th><th width="15%">JP</th></tr><tbody id="tblAtpBody"></tbody></table></div>
                    <div id="docProta" class="document-page d-none"><div class="doc-header">PROGRAM TAHUNAN (PROTA)</div><table class="identity-table mb-3"><tr><td width="15%">Sekolah</td><td>:</td><td class="vSekolah"></td><td width="15%">Kelas</td><td>:</td><td class="vFaseKelas"></td></tr></table><table class="doc-table"><tr><th>Semester</th><th>Materi Pokok</th><th>JP</th><th>Ket</th></tr><tbody id="tblProtaBody"></tbody></table></div>
                    <div id="docPromes" class="document-page d-none"><div class="doc-header">PROGRAM SEMESTER (PROMES)</div><table class="doc-table" style="font-size: 9pt;"><tr><th rowspan="2">Materi</th><th rowspan="2">JP</th><th colspan="4">Juli</th><th colspan="4">Agustus</th></tr><tr><th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th></tr><tbody id="tblPromesBody"></tbody></table></div>
                    
                    <div id="previewTahunan" class="alert alert-secondary text-center">Tekan "Generate Dokumen" untuk mengaktifkan cetak.</div>
                </div>

                <div id="tabPerangkat" class="tab-content d-none">
                     <div class="no-print card p-3 shadow-sm mb-3">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Jadwal Mengajar</label><select id="pSelectJadwal" class="form-select"></select></div>
                            <div class="col-md-3"><label class="small fw-bold">Bab Ke-</label><input type="number" id="pBab" class="form-control" value="1"></div>
                            <div class="col-md-3"><button class="btn btn-success w-100" onclick="generateModul()">Buat Modul</button></div>
                            <div class="col-md-2"><button class="btn btn-danger w-100" onclick="triggerPrint('docModul', 'Modul_Ajar', 'portrait')">PDF Modul</button></div>
                        </div>
                    </div>
                    <div id="docModul" class="document-page">
                        <div class="doc-header">MODUL AJAR PAI & BUDI PEKERTI</div>
                        <p id="outMateri" class="mb-3 text-justify">Silakan pilih jadwal dan generate materi.</p>
                        <div class="signature-area"><div class="signature-box">Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box">Guru PAI<div class="signature-name vGuru"></div></div></div>
                    </div>
                </div>

                <div id="tabPelaksanaan" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-danger">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Jadwal Hari Ini</label><select id="selectJadwalAbsen" class="form-select"></select></div>
                            <div class="col-md-4"><button class="btn btn-danger w-100" onclick="loadAbsensi()">Mulai Kelas (Absen)</button></div>
                            <div class="col-md-4 text-end"><button class="btn btn-outline-danger w-100" onclick="triggerPrint('docJurnal', 'Jurnal', 'landscape')">Cetak Jurnal (PDF)</button></div>
                        </div>
                    </div>
                    <div id="areaAbsen" class="d-none no-print mb-4 p-3 bg-white border rounded shadow-sm">
                        <div id="listSiswaAbsen" class="row mt-2"></div><button class="btn btn-primary mt-3" onclick="simpanJurnal()">Simpan ke Jurnal</button>
                    </div>
                    <div id="docJurnal" class="document-page"><div class="doc-header">JURNAL PEMBELAJARAN</div><table class="doc-table mt-2 text-center"><thead><tr><th>Hari/Tgl</th><th>Kelas</th><th>Materi</th><th>Absensi Siswa</th></tr></thead><tbody><tr><td id="jurTanggal"></td><td id="jurRombel"></td><td>Pelaksanaan Bab <span class="vBab">1</span></td><td>Hadir: <span id="jurHadir">0</span> | Absen: <span id="jurAbsen">0</span></td></tr></tbody></table></div>
                </div>

                <div id="tabPenilaian" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-info">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Pilih Kelas</label><select id="selectKelasNilai" class="form-select" onchange="loadPenilaian()"></select></div>
                            <div class="col-md-4"><label class="small fw-bold">Topik / Bab Penilaian</label><input type="text" id="topikNilai" class="form-control" value="Ulangan Harian Bab 1"></div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-info w-100" onclick="simpanNilai()">üíæ Simpan Nilai</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 text-end no-print"><button class="btn btn-outline-danger" onclick="triggerPrint('docNilai', 'Rekap_Nilai', 'portrait')">Cetak Rekap Nilai PDF</button></div>

                    <div id="docNilai" class="document-page">
                        <div class="doc-header">REKAPITULASI NILAI SISWA</div>
                        <table class="identity-table" style="width: 60%;">
                            <tr><td width="20%">Sekolah</td><td>:</td><td class="vSekolah"></td></tr>
                            <tr><td>Kelas / Rombel</td><td>:</td><td><b id="lblKelasNilai">...</b></td></tr>
                            <tr><td>Topik Penilaian</td><td>:</td><td><b id="lblTopikNilai">...</b></td></tr>
                        </table>
                        
                        <table class="doc-table mt-3 text-center">
                            <thead>
                                <tr>
                                    <th width="5%">No</th><th width="15%">NIS</th><th width="50%" class="text-start">Nama Siswa</th><th width="15%">L/P</th><th width="15%">Nilai Angka</th>
                                </tr>
                            </thead>
                            <tbody id="tblNilaiBody">
                                <tr><td colspan="5">Pilih kelas di atas untuk memuat data.</td></tr>
                            </tbody>
                        </table>
                        <div class="signature-area"><div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div></div><div class="signature-box"><span class="vTanggal"></span><br>Guru PAI<div class="signature-name vGuru"></div></div></div>
                    </div>
                </div>

                <div id="printArea" class="d-none"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCTEbggjJ5cguXAlq-QpbY5mO2G16S7rvQ", authDomain: "si-gumart.firebaseapp.com", projectId: "si-gumart", storageBucket: "si-gumart.firebasestorage.app", messagingSenderId: "544375918988", appId: "1:544375918988:web:a8459825c68810f22546a9" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();

        let currentUser = null, isBypass = false;
        let dataSiswa = JSON.parse(localStorage.getItem('pai_dataSiswa')) || [];
        let dataNilai = JSON.parse(localStorage.getItem('pai_dataNilai')) || {}; 

        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.remove('d-none');
            event.target.classList.add('active');
            updateUIProfile();
            if(tabId === 'tabPenilaian') renderKelasPenilaian();
        };

        window.triggerPrint = function(sourceId, pdfName, orientation) {
            updateUIProfile(); document.title = pdfName + "_" + new Date().getTime();
            document.body.classList.remove('landscape-print', 'portrait-print');
            document.body.classList.add(orientation + '-print');
            
            const printArea = document.getElementById('printArea'); printArea.innerHTML = '';
            const clone = document.getElementById(sourceId).cloneNode(true);
            clone.classList.remove('d-none'); clone.style.boxShadow = 'none'; clone.style.padding = '0';
            
            printArea.appendChild(clone); printArea.classList.remove('d-none');
            document.getElementById('mainContentArea').classList.add('d-none');
            window.print();
            printArea.classList.add('d-none'); document.getElementById('mainContentArea').classList.remove('d-none');
            document.title = "SIM PAI Terpadu Pro"; 
        };

        // AUTH
        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => alert(e.message)));
        document.getElementById('btnLogout').addEventListener('click', () => { if(isBypass) location.reload(); else signOut(auth); });
        window.bypassLogin = function() { isBypass = true; currentUser = { uid: "local_1", displayName: "Guru PAI Lokal" }; handleLoginSuccess(); };
        
        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; handleLoginSuccess(); } 
            else if (!isBypass) { document.getElementById('loginScreen').classList.remove('d-none'); document.getElementById('mainApp').classList.add('d-none'); }
        });

        function handleLoginSuccess() {
            document.getElementById('loginScreen').classList.add('d-none'); document.getElementById('mainApp').classList.remove('d-none');
            document.getElementById('userName').innerText = currentUser.displayName;
            loadProfil(); renderTabelSiswa(); loadJadwal();
        }

        // PROFIL & NPSN
        window.simpanProfil = function() {
            const p = { npsn: document.getElementById('profNpsn').value, sek: document.getElementById('profSekolah').value, thn: document.getElementById('profTahun').value, kep: document.getElementById('profKepsek').value, nkep: document.getElementById('profNipKepsek').value, gur: document.getElementById('profGuru').value, ngur: document.getElementById('profNipGuru').value, tgl: document.getElementById('profTanggal').value };
            if(!p.npsn) return alert("NPSN Sekolah Wajib Diisi!");
            localStorage.setItem('pai_prof', JSON.stringify(p)); alert("Profil Tersimpan!"); updateUIProfile(); loadJadwal();
        };
        function loadProfil() {
            const p = JSON.parse(localStorage.getItem('pai_prof'));
            if(p) { document.getElementById('profNpsn').value = p.npsn||''; document.getElementById('profSekolah').value = p.sek; document.getElementById('profTahun').value = p.thn; document.getElementById('profKepsek').value = p.kep; document.getElementById('profNipKepsek').value = p.nkep; document.getElementById('profGuru').value = p.gur; document.getElementById('profNipGuru').value = p.ngur; document.getElementById('profTanggal').value = p.tgl; }
            updateUIProfile();
        }
        function updateUIProfile() {
            const p = JSON.parse(localStorage.getItem('pai_prof')) || {};
            document.querySelectorAll('.vNpsn').forEach(e => e.innerText = p.npsn || 'Belum Diset');
            document.querySelectorAll('.vSekolah').forEach(e => e.innerText = p.sek || '...');
            // [Inject rest of properties to class vTanggal, vKepsek, etc as usual...]
        }

        // CSV DATA SISWA (Lokal & Online)
        function prosesDataCsv(dataArray, kelasTujuan) {
            let hitung = 0;
            dataArray.forEach(s => { 
                if(s.Nama || s.nama) {
                    dataSiswa.push({ nis: s.NIS||s.nis||'-', nama: s.Nama||s.nama, lp: s['L/P']||s.LP||s.JK||'-', kelas: kelasTujuan });
                    hitung++;
                }
            });
            localStorage.setItem('pai_dataSiswa', JSON.stringify(dataSiswa)); 
            renderTabelSiswa(); alert(`${hitung} data siswa berhasil diimport ke ${kelasTujuan}!`);
        }

        window.importSiswaLokal = function() {
            const file = document.getElementById('fileCsvSiswa').files[0]; const kls = document.getElementById('inputSiswaKelas').value.trim();
            if(!file || !kls) return alert("Pilih file dan ketik kelas tujuan!");
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: function(r) { prosesDataCsv(r.data, kls); }});
        };

        window.importSiswaUrl = function() {
            const url = document.getElementById('inputCsvUrl').value.trim(); const kls = document.getElementById('inputSiswaKelas').value.trim();
            if(!url || !kls) return alert("Masukkan URL CSV dan ketik kelas tujuan!");
            Papa.parse(url, { download: true, header: true, skipEmptyLines: true, 
                complete: function(r) { prosesDataCsv(r.data, kls); },
                error: function(e) { alert("Gagal mengambil data dari URL. Pastikan URL valid dan bersifat Publik."); }
            });
        };

        window.clearDataSiswa = function() { if(confirm("Hapus semua siswa?")){ dataSiswa=[]; localStorage.removeItem('pai_dataSiswa'); renderTabelSiswa();} }

        window.renderTabelSiswa = function() {
            const f = document.getElementById('filterKelasSiswa').value;
            let o = '<option value="ALL">-- Semua Kelas --</option>';
            new Set(dataSiswa.map(s => s.kelas)).forEach(k => o += `<option value="${k}" ${f===k?'selected':''}>${k}</option>`);
            document.getElementById('filterKelasSiswa').innerHTML = o;
            let tb = ''; (f==="ALL"?dataSiswa:dataSiswa.filter(s=>s.kelas===f)).forEach(s => tb += `<tr><td>${s.nis}</td><td>${s.nama}</td><td>${s.lp}</td><td>${s.kelas}</td></tr>`);
            document.getElementById('tabelSiswaBody').innerHTML = tb || '<tr><td colspan="4">Kosong</td></tr>';
        };

        // JADWAL (NPSN Anti-Bentrok Firebase Client-Side Validation)
        document.getElementById('btnTambahJadwal').addEventListener('click', async () => {
            const p = JSON.parse(localStorage.getItem('pai_prof'));
            if(!p || !p.npsn) return alert("Buka tab Profil Instansi dan isi NPSN terlebih dahulu!");
            
            const h = document.getElementById('jadwalHari').value, j = document.getElementById('jadwalJam').value, r = document.getElementById('jadwalRombel').value, f = document.getElementById('jadwalFase').value, m = document.getElementById('msgJadwal');
            if(!j || !r) return alert("Isi Jam & Rombel!"); m.innerText = "Mengecek Server...";

            if(!isBypass) {
                // Tarik semua jadwal berdasarkan NPSN sekolah ini
                const qs = await getDocs(query(collection(db, "jadwal"), where("npsn", "==", p.npsn)));
                let b = false; 
                qs.forEach(d => { 
                    let dt = d.data();
                    if(dt.hari === h && dt.jam === j) { // Cek bentrok jam
                        if(dt.uid === currentUser.uid) { b = true; m.innerText = `BENTROK: Anda sudah mengajar di kelas ${dt.rombel} pada jam ini!`; }
                        else if(dt.rombel === r) { b = true; m.innerText = `BENTROK: Kelas ${r} sedang diajar oleh guru lain di jam ini!`; }
                    }
                });
                if(!b) { await addDoc(collection(db, "jadwal"), { npsn: p.npsn, uid: currentUser.uid, hari:h, jam:j, rombel:r, fase:f }); m.innerText = "Jadwal sukses ditambahkan!"; }
            } else { m.innerText = "Lokal: Jadwal ditambahkan."; }
        });

        function loadJadwal() {
            if(!isBypass) {
                onSnapshot(query(collection(db, "jadwal"), where("uid", "==", currentUser.uid)), (snap) => {
                    let h='', o='<option value="">Pilih Jadwal</option>'; 
                    snap.forEach(doc => { let d=doc.data(); h+=`<tr><td>${d.hari}</td><td>Ke-${d.jam}</td><td>${d.rombel}</td><td>${d.fase}</td><td>Hapus</td></tr>`; o+=`<option value='${JSON.stringify(d)}'>${d.hari} Jam ${d.jam} - ${d.rombel}</option>`; });
                    document.getElementById('tabelJadwalBody').innerHTML = h; document.getElementById('pSelectJadwal').innerHTML = o; document.getElementById('selectJadwalAbsen').innerHTML = o;
                });
            }
        }

        // PENILAIAN
        window.renderKelasPenilaian = function() {
            let o = '<option value="">-- Pilih Kelas --</option>';
            new Set(dataSiswa.map(s => s.kelas)).forEach(k => o += `<option value="${k}">${k}</option>`);
            document.getElementById('selectKelasNilai').innerHTML = o;
        };

        window.loadPenilaian = function() {
            const kls = document.getElementById('selectKelasNilai').value;
            document.getElementById('lblKelasNilai').innerText = kls;
            document.getElementById('lblTopikNilai').innerText = document.getElementById('topikNilai').value;
            
            const siswaKelas = dataSiswa.filter(s => s.kelas === kls);
            let tb = '';
            siswaKelas.forEach((s, idx) => {
                let keyNilai = `${kls}_${s.nis}`;
                let nilaiSiswa = dataNilai[keyNilai] || '';
                tb += `<tr>
                    <td>${idx+1}</td><td>${s.nis}</td><td class="text-start">${s.nama}</td><td>${s.lp}</td>
                    <td class="no-print"><input type="number" class="form-control input-nilai text-center" data-nis="${s.nis}" value="${nilaiSiswa}"></td>
                    <td class="d-none print-only-td">${nilaiSiswa}</td>
                </tr>`;
            });
            // Update CSS rule for print dynamic TD
            tb += `<style>@media print { .input-nilai { display: none !important; } .print-only-td { display: table-cell !important; } }</style>`;
            document.getElementById('tblNilaiBody').innerHTML = tb || '<tr><td colspan="5">Kosong</td></tr>';
        };

        window.simpanNilai = function() {
            const kls = document.getElementById('selectKelasNilai').value;
            if(!kls) return alert("Pilih kelas dulu!");
            document.querySelectorAll('.input-nilai').forEach(el => {
                dataNilai[`${kls}_${el.getAttribute('data-nis')}`] = el.value;
            });
            localStorage.setItem('pai_dataNilai', JSON.stringify(dataNilai));
            alert("Nilai berhasil disimpan!"); loadPenilaian(); // Refresh to inject to print TD
        };

        // BUNDLED DUMMY GENERATORS
        window.generateTahunan=function(){ document.getElementById('docATP').classList.remove('d-none');document.getElementById('docProta').classList.remove('d-none');document.getElementById('docPromes').classList.remove('d-none');document.getElementById('previewTahunan').innerText="Dokumen Siap Dicetak!"; };
        window.generateModul=function(){ alert("Modul siap dicetak."); };
        window.loadAbsensi=function(){ document.getElementById('areaAbsen').classList.remove('d-none'); document.getElementById('listSiswaAbsen').innerHTML='<p>Asumsikan daftar siswa tampil disini.</p>';};
        window.simpanJurnal=function(){ alert("Jurnal disimpan."); };

    </script>
</body>
</html>
