<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM PAI Terpadu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* Base Styles */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background-color: #1a252f; color: white; padding-top: 20px;}
        .sidebar .nav-link { color: #bdc3c7; cursor: pointer; margin-bottom: 5px; font-weight: 500; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #2c3e50; border-radius: 5px; }
        .content-area { padding: 20px; height: 100vh; overflow-y: auto; }
        
        /* Document / Print Template Styles */
        .document-page { 
            background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin-bottom: 20px; font-family: 'Times New Roman', Times, serif; color: black; 
            max-width: 100%; overflow-x: auto;
        }
        .doc-header { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 15px; text-transform: uppercase; line-height: 1.3; }
        table.doc-table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-bottom: 15px; }
        table.doc-table th, table.doc-table td { border: 1px solid black; padding: 8px; vertical-align: top; }
        table.doc-table th { background-color: #f8f9fa; text-align: center; font-weight: bold; }
        table.identity-table { width: 100%; margin-bottom: 15px; font-size: 11pt; }
        table.identity-table td { padding: 4px; vertical-align: top; }
        
        /* LKPD Specific Styles */
        .lkpd-box { border: 2px solid #000; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .lkpd-score-box { border: 2px solid #000; padding: 10px; width: 120px; text-align: center; font-weight: bold; font-size: 14pt; float: right; height: 80px;}
        .lkpd-answer-area { border: 1px dashed #000; min-height: 200px; padding: 15px; background: #fafafa; margin-top: 15px; line-height: 2; background-image: repeating-linear-gradient(transparent, transparent 31px, #ccc 31px, #ccc 32px); }

        /* Signature Area */
        .signature-area { width: 100%; margin-top: 40px; display: table; page-break-inside: avoid; }
        .signature-box { display: table-cell; width: 50%; text-align: center; font-size: 11pt; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 75px; }

        /* Print Media Queries */
        @media print {
            @page { margin: 15mm; }
            body { background-color: white; }
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .sidebar { display: none !important; }
            .content-area { width: 100% !important; height: auto !important; padding: 0 !important; overflow: visible !important; }
            .document-page { box-shadow: none; margin: 0; padding: 0; max-width: 100%; border: none; }
            
            /* Orientation overrides via JS classes */
            .landscape-print { @page { size: landscape; } }
            .portrait-print { @page { size: portrait; } }
            
            /* Table formatting for print */
            table.doc-table { width: 100% !important; }
            table.doc-table th { -webkit-print-color-adjust: exact; background-color: #e9ecef !important; }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-5 text-center shadow" style="max-width: 450px;">
            <h3 class="mb-3 text-success">üìö SIM PAI Terpadu</h3>
            <p class="text-muted small">Cetak PDF Prota, Promes, ATP, Modul, LKPD, dan Jurnal.</p>
            <button id="btnLogin" class="btn btn-danger mt-3">üåê Sign in with Google / belajar.id</button>
            <button class="btn btn-outline-secondary mt-3 btn-sm" onclick="bypassLogin()">Mode Uji Coba (Bypass)</button>
        </div>
    </div>

    <div id="mainApp" class="container-fluid d-none">
        <div class="row">
            <div class="col-md-2 sidebar flex-column no-print">
                <h6 class="text-center text-warning mb-4 fw-bold">GURU PAI PRO</h6>
                <div class="text-center mb-3">
                    <img id="userAvatar" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" class="rounded-circle mb-2 bg-secondary" width="60" height="60" alt="User">
                    <div id="userName" class="small fw-bold"></div>
                    <button id="btnLogout" class="btn btn-sm btn-outline-light mt-2" style="font-size: 0.7rem;">Logout</button>
                </div>
                <hr class="bg-light">
                <nav class="nav flex-column small">
                    <a class="nav-link active" onclick="showTab('tabDashboard')">üè† Dashboard</a>
                    <a class="nav-link" onclick="showTab('tabProfil')">üè´ Profil Instansi</a>
                    <a class="nav-link" onclick="showTab('tabSiswa')">üë• Data Siswa & Kelas</a>
                    <a class="nav-link" onclick="showTab('tabJadwal')">üìÖ Jadwal (Anti-Bentrok)</a>
                    <a class="nav-link" onclick="showTab('tabTahunan')">üìÅ ATP, Prota, Promes</a>
                    <a class="nav-link" onclick="showTab('tabPerangkat')">üìñ Modul Ajar</a>
                    <a class="nav-link" onclick="showTab('tabEvaluasi')">üìù LKPD & Evaluasi</a>
                    <a class="nav-link" onclick="showTab('tabPelaksanaan')">üìã Absen & Jurnal</a>
                </nav>
            </div>

            <div class="col-md-10 content-area" id="mainContentArea">
                
                <div id="tabDashboard" class="tab-content">
                    <h3 class="mb-4">Selamat Datang di Sistem Terpadu PAI</h3>
                    <div class="alert alert-info shadow-sm">
                        <strong>Panduan Cepat:</strong><br>
                        1. Lengkapi <b>Profil Instansi</b>.<br>
                        2. Import <b>Data Siswa</b>.<br>
                        3. Buka tab <b>ATP, Prota, Promes</b> untuk merencanakan setahun, lalu cetak PDF.<br>
                        4. Buat <b>Modul & LKPD</b>, lalu cetak ke PDF.<br>
                        5. Buka <b>Absen & Jurnal</b> setiap selesai mengajar untuk rekap otomatis.
                    </div>
                </div>

                <div id="tabProfil" class="tab-content d-none no-print">
                    <h3 class="mb-3">Profil Instansi & Guru</h3>
                    <div class="card p-4 shadow-sm mb-4">
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label small fw-bold">Sekolah</label><input type="text" id="profSekolah" class="form-control" placeholder="SDN ..."></div>
                            <div class="col-md-6"><label class="form-label small fw-bold">Tahun Ajaran</label><input type="text" id="profTahun" class="form-control" value="2025/2026"></div>
                            <div class="col-md-6"><label class="form-label small fw-bold">Kepala Sekolah</label><input type="text" id="profKepsek" class="form-control"></div>
                            <div class="col-md-6"><label class="form-label small fw-bold">NIP Kepsek</label><input type="text" id="profNipKepsek" class="form-control"></div>
                            <div class="col-md-6"><label class="form-label small fw-bold">Guru PAI</label><input type="text" id="profGuru" class="form-control"></div>
                            <div class="col-md-6"><label class="form-label small fw-bold">NIP Guru</label><input type="text" id="profNipGuru" class="form-control"></div>
                            <div class="col-md-12"><label class="form-label small fw-bold">Tempat, Tgl Pengesahan</label><input type="text" id="profTanggal" class="form-control" placeholder="Jakarta, 15 Juli 2025"></div>
                            <div class="col-md-12 mt-3"><button class="btn btn-success" onclick="simpanProfil()">üíæ Simpan</button></div>
                        </div>
                    </div>
                </div>

                <div id="tabSiswa" class="tab-content d-none no-print">
                    <h3 class="mb-3">Data Siswa per Kelas</h3>
                    <div class="card p-3 mb-4 shadow-sm">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3"><label class="small fw-bold">Tujuan Kelas</label><input type="text" id="inputSiswaKelas" class="form-control" placeholder="Misal: Kelas 3A"></div>
                            <div class="col-md-6"><label class="small fw-bold">Upload CSV (NIS, Nama, L/P)</label><input type="file" id="fileCsvSiswa" class="form-control" accept=".csv"></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="importSiswa()">Import CSV</button></div>
                        </div>
                    </div>
                    <select id="filterKelasSiswa" class="form-select w-25 mb-2" onchange="renderTabelSiswa()"><option value="ALL">-- Semua Kelas --</option></select>
                    <table class="table table-bordered bg-white shadow-sm"><thead class="table-dark"><tr><th>NIS</th><th>Nama Siswa</th><th>L/P</th><th>Kelas</th></tr></thead><tbody id="tabelSiswaBody"></tbody></table>
                </div>

                <div id="tabJadwal" class="tab-content d-none no-print">
                    <h3 class="mb-3">Jadwal Anti-Bentrok</h3>
                    <div class="card p-3 shadow-sm mb-3">
                        <div class="row g-2">
                            <div class="col-md-2"><select id="jadwalHari" class="form-select"><option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option></select></div>
                            <div class="col-md-2"><input type="number" id="jadwalJam" class="form-control" placeholder="Jam Ke-"></div>
                            <div class="col-md-3"><input type="text" id="jadwalRombel" class="form-control" placeholder="Kelas (Misal: 3A)"></div>
                            <div class="col-md-3"><select id="jadwalFase" class="form-select"><option value="A">Fase A (Kls 1-2)</option><option value="B">Fase B (Kls 3-4)</option><option value="C">Fase C (Kls 5-6)</option></select></div>
                            <div class="col-md-2"><button class="btn btn-success w-100" id="btnTambahJadwal">Tambah</button></div>
                        </div>
                        <small class="text-danger mt-1 fw-bold" id="msgJadwal"></small>
                    </div>
                    <table class="table table-striped bg-white shadow-sm"><thead class="table-dark"><tr><th>Hari</th><th>Jam</th><th>Kelas</th><th>Fase</th><th>Aksi</th></tr></thead><tbody id="tabelJadwalBody"></tbody></table>
                </div>

                <div id="tabTahunan" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-primary">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3"><label class="small fw-bold">Pilih Fase & Kelas</label><select id="tFase" class="form-select"><option value="A">Fase A (Kelas 1)</option><option value="B">Fase B (Kelas 3)</option><option value="C">Fase C (Kelas 5)</option></select></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="generateTahunan()">Generate Dokumen</button></div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-danger" onclick="triggerPrint('docATP', 'ATP_PAI', 'portrait')">PDF ATP</button>
                                <button class="btn btn-outline-danger" onclick="triggerPrint('docProta', 'Prota_PAI', 'portrait')">PDF Prota</button>
                                <button class="btn btn-outline-danger" onclick="triggerPrint('docPromes', 'Promes_PAI', 'landscape')">PDF Promes</button>
                            </div>
                        </div>
                    </div>

                    <div id="printArea" class="d-none"></div>

                    <div id="previewTahunan" class="document-page">
                        <div class="alert alert-secondary text-center">Tekan "Generate Dokumen" lalu pilih tombol PDF di atas untuk mencetak ATP, Prota, atau Promes.</div>
                    </div>

                    <div id="tplATP" class="d-none">
                        <div class="doc-header">ALUR TUJUAN PEMBELAJARAN (ATP)<br>PENDIDIKAN AGAMA ISLAM</div>
                        <table class="identity-table mb-3">
                            <tr><td width="15%">Satuan Pendidikan</td><td width="2%">:</td><td class="vSekolah"></td><td width="15%">Fase / Kelas</td><td width="2%">:</td><td class="vFaseKelas"></td></tr>
                            <tr><td>Mata Pelajaran</td><td>:</td><td>PAI & Budi Pekerti</td><td>Tahun Ajaran</td><td>:</td><td class="vTahun"></td></tr>
                        </table>
                        <table class="doc-table">
                            <tr><th width="10%">Semester</th><th width="15%">Elemen</th><th width="60%">Tujuan Pembelajaran (TP) & Integrasi Profil</th><th width="15%">Alokasi Waktu</th></tr>
                            <tbody id="tblAtpBody"></tbody>
                        </table>
                        <div class="signature-area"><div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div>NIP. <span class="vNipKepsek"></span></div><div class="signature-box"><span class="vTanggal"></span><br>Guru PAI<div class="signature-name vGuru"></div>NIP. <span class="vNipGuru"></span></div></div>
                    </div>

                    <div id="tplProta" class="d-none">
                        <div class="doc-header">PROGRAM TAHUNAN (PROTA)</div>
                        <table class="identity-table mb-3"><tr><td width="15%">Sekolah</td><td>:</td><td class="vSekolah"></td><td width="15%">Kelas/Fase</td><td>:</td><td class="vFaseKelas"></td></tr></table>
                        <table class="doc-table">
                            <tr><th>Semester</th><th>Bab / Materi Pokok</th><th>Alokasi Waktu (JP)</th><th>Keterangan</th></tr>
                            <tbody id="tblProtaBody"></tbody>
                        </table>
                        <div class="signature-area"><div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div>NIP. <span class="vNipKepsek"></span></div><div class="signature-box"><span class="vTanggal"></span><br>Guru PAI<div class="signature-name vGuru"></div>NIP. <span class="vNipGuru"></span></div></div>
                    </div>

                    <div id="tplPromes" class="d-none">
                        <div class="doc-header">PROGRAM SEMESTER (PROMES) GANJIL</div>
                        <table class="identity-table mb-2"><tr><td width="10%">Sekolah</td><td>:</td><td class="vSekolah"></td><td width="10%">Kelas</td><td>:</td><td class="vFaseKelas"></td></tr></table>
                        <table class="doc-table" style="font-size: 9pt;">
                            <tr><th rowspan="2">Bab / Materi Pokok</th><th rowspan="2">JP</th><th colspan="4">Juli</th><th colspan="4">Agustus</th><th colspan="4">September</th><th colspan="4">Oktober</th><th colspan="4">November</th><th colspan="4">Desember</th></tr>
                            <tr>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th><th>1</th><th>2</th><th>3</th><th>4</th>
                            </tr>
                            <tbody id="tblPromesBody"></tbody>
                        </table>
                        <div class="signature-area mt-4"><div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div>NIP. <span class="vNipKepsek"></span></div><div class="signature-box"><span class="vTanggal"></span><br>Guru PAI<div class="signature-name vGuru"></div>NIP. <span class="vNipGuru"></span></div></div>
                    </div>
                </div>

                <div id="tabPerangkat" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-success">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Jadwal Mengajar</label><select id="pSelectJadwal" class="form-select"></select></div>
                            <div class="col-md-3"><label class="small fw-bold">Bab Ke-</label><input type="number" id="pBab" class="form-control" value="1"></div>
                            <div class="col-md-3"><button class="btn btn-success w-100" onclick="generateModul()">Buat Modul</button></div>
                            <div class="col-md-2"><button class="btn btn-outline-danger w-100" onclick="triggerPrint('docModul', 'Modul_Ajar', 'portrait')">PDF</button></div>
                        </div>
                    </div>
                    
                    <div id="docModul" class="document-page">
                        <div class="doc-header">MODUL AJAR PAI & BUDI PEKERTI<br>KURIKULUM MERDEKA</div>
                        <b>A. INFORMASI UMUM</b>
                        <table class="identity-table mt-2 mb-3">
                            <tr><td width="20%">Penyusun</td><td>:</td><td class="vGuru fw-bold"></td><td width="15%">Instansi</td><td>:</td><td class="vSekolah"></td></tr>
                            <tr><td>Fase / Kelas</td><td>:</td><td><span id="outFase"></span> / <span id="outRombel"></span></td><td>Alokasi Waktu</td><td>:</td><td>4 JP / 1 Pertemuan</td></tr>
                        </table>
                        <b>B. INTEGRASI 8 PROFIL LULUSAN</b>
                        <p class="small">Modul ini memuat nilai: 1. Keimanan, 2. Kewargaan, 3. Penalaran Kritis, 4. Kreativitas, 5. Kolaborasi, 6. Kemandirian, 7. Kesehatan, 8. Komunikasi.</p>
                        <b>C. KOMPONEN INTI</b>
                        <p id="outMateri" class="mb-3 text-justify">Pilih jadwal dan klik Buat Modul untuk menghasilkan materi.</p>
                        <b>D. KEGIATAN PEMBELAJARAN</b>
                        <table class="doc-table mt-2">
                            <tr><th width="20%">Tahap</th><th>Deskripsi Kegiatan</th></tr>
                            <tr><td><b>Pendahuluan</b><br>(15 Menit)</td><td>1. Berdoa <i>(Keimanan)</i>.<br>2. Cek kebersihan <i>(Kesehatan)</i> dan presensi.<br>3. Apersepsi materi Bab <span class="vBab"></span>.</td></tr>
                            <tr><td><b>Inti</b><br>(110 Menit)</td><td>1. Penjelasan materi Bab <span class="vBab"></span>.<br>2. Diskusi kelompok <i>(Kolaborasi, Komunikasi)</i>.<br>3. Pemecahan masalah <i>(Penalaran Kritis, Kreativitas)</i>.<br>4. Presentasi mandiri <i>(Kemandirian)</i>.</td></tr>
                            <tr><td><b>Penutup</b><br>(15 Menit)</td><td>1. Kesimpulan bersama <i>(Kewargaan)</i>.<br>2. Doa penutup.</td></tr>
                        </table>
                        <div class="signature-area"><div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div>NIP. <span class="vNipKepsek"></span></div><div class="signature-box"><span class="vTanggal"></span><br>Guru PAI<div class="signature-name vGuru"></div>NIP. <span class="vNipGuru"></span></div></div>
                    </div>
                </div>

                <div id="tabEvaluasi" class="tab-content d-none">
                    <div class="no-print mb-3 text-end"><button class="btn btn-outline-danger" onclick="triggerPrint('docLKPD', 'LKPD_Siswa', 'portrait')">Cetak LKPD ke PDF</button></div>
                    
                    <div id="docLKPD" class="document-page">
                        <div class="lkpd-box">
                            <div class="lkpd-score-box">NILAI / PARAF<br><br></div>
                            <div class="doc-header" style="text-align: left; margin-bottom: 5px;">LEMBAR KERJA PESERTA DIDIK (LKPD)</div>
                            <div style="font-weight: bold; font-size: 12pt; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 15px;">MATA PELAJARAN: PAI & BUDI PEKERTI</div>
                            
                            <table style="width: 60%; font-size: 11pt; line-height: 1.8;">
                                <tr><td width="20%">Nama Siswa</td><td width="5%">:</td><td style="border-bottom: 1px dotted black;"></td></tr>
                                <tr><td>Kelas/Rombel</td><td>:</td><td style="border-bottom: 1px dotted black;" class="vRombelPrint"></td></tr>
                                <tr><td>Hari/Tanggal</td><td>:</td><td style="border-bottom: 1px dotted black;"></td></tr>
                            </table>
                            
                            <div class="mt-4">
                                <b>A. Petunjuk Pengerjaan</b>
                                <ol class="small">
                                    <li>Berdoalah sebelum mengerjakan tugas ini <i>(Keimanan)</i>.</li>
                                    <li>Kerjakan dengan jujur dan tidak mencontek <i>(Kemandirian)</i>.</li>
                                    <li>Gunakan daya nalar untuk menjawab pertanyaan <i>(Penalaran Kritis)</i>.</li>
                                </ol>
                            </div>

                            <div class="mt-3">
                                <b>B. Soal Evaluasi / Tugas (Bab <span class="vBab">1</span>)</b>
                                <p>Jawablah pertanyaan-pertanyaan berikut dengan jelas dan tepat pada kolom yang disediakan!</p>
                                <ol>
                                    <li>Apa pesan pokok dari materi yang kita pelajari hari ini?</li>
                                    <li>Jelaskan bagaimana cara menerapkannya dalam kehidupan sehari-hari!</li>
                                </ol>
                                
                                <div class="lkpd-answer-area">
                                    <i>Ruang Jawaban:</i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabPelaksanaan" class="tab-content d-none">
                    <div class="no-print card p-3 shadow-sm mb-3 border-danger">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4"><label class="small fw-bold">Pilih Jadwal Mengajar Hari Ini</label><select id="selectJadwalAbsen" class="form-select"></select></div>
                            <div class="col-md-3"><button class="btn btn-danger w-100" onclick="loadAbsensi()">Mulai Kelas (Absen)</button></div>
                            <div class="col-md-5 text-end"><button class="btn btn-outline-danger" onclick="triggerPrint('docJurnal', 'Jurnal_Guru', 'landscape')">Cetak Jurnal (PDF)</button></div>
                        </div>
                    </div>

                    <div id="areaAbsen" class="d-none no-print mb-4 p-3 bg-white border rounded shadow-sm">
                        <h6 class="fw-bold">Ceklist Kehadiran: <span id="labelKelasAbsen" class="text-primary"></span></h6>
                        <div id="listSiswaAbsen" class="row mt-2"></div>
                        <div class="mt-3 text-end"><button class="btn btn-primary btn-sm" onclick="simpanJurnal()">Terapkan ke Jurnal</button></div>
                    </div>
                    
                    <div id="docJurnal" class="document-page">
                        <div class="doc-header">JURNAL PELAKSANAAN PEMBELAJARAN (AGENDA GURU)</div>
                        <table class="identity-table" style="width: 50%;">
                            <tr><td width="30%">Nama Sekolah</td><td>:</td><td class="vSekolah fw-bold"></td></tr>
                            <tr><td>Mata Pelajaran</td><td>:</td><td>PAI & Budi Pekerti</td></tr>
                            <tr><td>Nama Guru</td><td>:</td><td class="vGuru"></td></tr>
                        </table>

                        <table class="doc-table mt-2 text-center">
                            <thead>
                                <tr>
                                    <th width="5%">No</th>
                                    <th width="12%">Hari/Tgl</th>
                                    <th width="8%">Kelas</th>
                                    <th width="5%">JP</th>
                                    <th width="20%">Materi / Kompetensi</th>
                                    <th width="20%">Kegiatan (Integrasi 8 Profil)</th>
                                    <th width="15%">Absensi Siswa</th>
                                    <th width="15%">Catatan Guru</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td id="jurTanggal">...</td>
                                    <td id="jurRombel">...</td>
                                    <td id="jurJam">...</td>
                                    <td class="text-start">Pembelajaran Bab <span class="vBab"></span> sesuai ATP Kurikulum Merdeka.</td>
                                    <td class="text-start" style="font-size:10pt;">Proses KBM lancar. Profil Kemandirian, Penalaran Kritis, dan Keimanan diterapkan.</td>
                                    <td class="text-start" style="font-size:10pt;">Hadir: <span id="jurHadir" class="fw-bold">0</span><br>Tidak Hadir: <span id="jurAbsen" class="fw-bold text-danger">0</span><br><div id="jurListAbsen" class="small"></div></td>
                                    <td>Tuntas / Lanjut</td>
                                </tr>
                                <tr><td style="height:40px;">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><td style="height:40px;">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            </tbody>
                        </table>

                        <div class="signature-area mt-4">
                            <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name vKepsek"></div>NIP. <span class="vNipKepsek"></span></div>
                            <div class="signature-box"><span class="vTanggal"></span><br>Guru Pendidikan Agama Islam<div class="signature-name vGuru"></div>NIP. <span class="vNipGuru"></span></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCTEbggjJ5cguXAlq-QpbY5mO2G16S7rvQ", authDomain: "si-gumart.firebaseapp.com",
            projectId: "si-gumart", storageBucket: "si-gumart.firebasestorage.app",
            messagingSenderId: "544375918988", appId: "1:544375918988:web:a8459825c68810f22546a9"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isBypass = false, dataSiswa = JSON.parse(localStorage.getItem('pai_dataSiswa')) || [];

        // UI Tabs
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.remove('d-none');
            event.target.classList.add('active');
            updateUIProfile();
        };

        // Advanced Print Logic for PDF
        window.triggerPrint = function(sourceId, pdfName, orientation) {
            updateUIProfile();
            document.title = pdfName + "_" + new Date().getTime(); // Fix PDF save name
            
            // Apply orientation class
            document.body.classList.remove('landscape-print', 'portrait-print');
            document.body.classList.add(orientation + '-print');
            
            // Move content to isolated print area to ensure margins and page breaks work perfectly
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';
            
            // Clone the targeted document
            const sourceEl = document.getElementById(sourceId);
            const clone = sourceEl.cloneNode(true);
            clone.classList.remove('d-none');
            clone.style.boxShadow = 'none';
            clone.style.padding = '0';
            
            printArea.appendChild(clone);
            printArea.classList.remove('d-none');
            document.getElementById('mainContentArea').classList.add('d-none'); // Hide rest of UI

            window.print();

            // Restore
            printArea.classList.add('d-none');
            printArea.innerHTML = '';
            document.getElementById('mainContentArea').classList.remove('d-none');
            document.title = "SIM PAI Terpadu"; 
        };

        // AUTH
        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => alert(e.message)));
        document.getElementById('btnLogout').addEventListener('click', () => { if(isBypass) location.reload(); else signOut(auth); });
        window.bypassLogin = function() { isBypass = true; currentUser = { uid: "local_1", displayName: "Guru PAI Mode Lokal" }; handleLoginSuccess(); };
        
        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; handleLoginSuccess(); } 
            else if (!isBypass) { document.getElementById('loginScreen').classList.remove('d-none'); document.getElementById('mainApp').classList.add('d-none'); }
        });

        function handleLoginSuccess() {
            document.getElementById('loginScreen').classList.add('d-none'); document.getElementById('mainApp').classList.remove('d-none');
            document.getElementById('userName').innerText = currentUser.displayName;
            if(currentUser.photoURL) document.getElementById('userAvatar').src = currentUser.photoURL;
            loadProfil(); renderTabelSiswa(); loadJadwal();
        }

        // PROFIL
        window.simpanProfil = function() {
            const p = { sek: document.getElementById('profSekolah').value, thn: document.getElementById('profTahun').value,
                kep: document.getElementById('profKepsek').value, nkep: document.getElementById('profNipKepsek').value,
                gur: document.getElementById('profGuru').value, ngur: document.getElementById('profNipGuru').value, tgl: document.getElementById('profTanggal').value };
            localStorage.setItem('pai_prof', JSON.stringify(p)); alert("Profil Tersimpan!"); updateUIProfile();
        };
        function loadProfil() {
            const p = JSON.parse(localStorage.getItem('pai_prof'));
            if(p) { document.getElementById('profSekolah').value = p.sek; document.getElementById('profTahun').value = p.thn; document.getElementById('profKepsek').value = p.kep; document.getElementById('profNipKepsek').value = p.nkep; document.getElementById('profGuru').value = p.gur; document.getElementById('profNipGuru').value = p.ngur; document.getElementById('profTanggal').value = p.tgl; }
            updateUIProfile();
        }
        function updateUIProfile() {
            const p = JSON.parse(localStorage.getItem('pai_prof')) || {};
            document.querySelectorAll('.vSekolah').forEach(e => e.innerText = p.sek || '...');
            document.querySelectorAll('.vTahun').forEach(e => e.innerText = p.thn || '...');
            document.querySelectorAll('.vKepsek').forEach(e => e.innerText = p.kep || '...');
            document.querySelectorAll('.vNipKepsek').forEach(e => e.innerText = p.nkep || '...');
            document.querySelectorAll('.vGuru').forEach(e => e.innerText = p.gur || '...');
            document.querySelectorAll('.vNipGuru').forEach(e => e.innerText = p.ngur || '...');
            document.querySelectorAll('.vTanggal').forEach(e => e.innerText = p.tgl || '...');
        }

        // SISWA
        window.importSiswa = function() {
            const file = document.getElementById('fileCsvSiswa').files[0]; const kelas = document.getElementById('inputSiswaKelas').value.trim();
            if(!file || !kelas) return alert("Pilih file CSV dan isi Rombel tujuan!");
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: function(r) {
                r.data.forEach(s => { if(s.Nama || s.nama) dataSiswa.push({ nis: s.NIS||s.nis||'-', nama: s.Nama||s.nama, lp: s['L/P']||s.LP||'-', kelas: kelas }); });
                localStorage.setItem('pai_dataSiswa', JSON.stringify(dataSiswa)); renderTabelSiswa(); alert("Import Sukses!");
            }});
        };
        window.renderTabelSiswa = function() {
            const filter = document.getElementById('filterKelasSiswa').value;
            let opt = '<option value="ALL">-- Semua Kelas --</option>';
            new Set(dataSiswa.map(s => s.kelas)).forEach(k => opt += `<option value="${k}" ${filter===k?'selected':''}>${k}</option>`);
            document.getElementById('filterKelasSiswa').innerHTML = opt;
            let tb = ''; (filter==="ALL"?dataSiswa:dataSiswa.filter(s=>s.kelas===filter)).forEach(s => { tb += `<tr><td>${s.nis}</td><td>${s.nama}</td><td>${s.lp}</td><td>${s.kelas}</td></tr>`; });
            document.getElementById('tabelSiswaBody').innerHTML = tb || '<tr><td colspan="4">Kosong</td></tr>';
        };

        // JADWAL
        document.getElementById('btnTambahJadwal').addEventListener('click', async () => {
            const h = document.getElementById('jadwalHari').value, j = document.getElementById('jadwalJam').value, r = document.getElementById('jadwalRombel').value, f = document.getElementById('jadwalFase').value, m = document.getElementById('msgJadwal');
            if(!j || !r) return alert("Jam & Rombel wajib isi!"); m.innerText = "Cek bentrok...";
            if(!isBypass) {
                const qs = await getDocs(query(collection(db, "jadwal"), where("hari", "==", h), where("jam", "==", j)));
                let b = false; qs.forEach(d => { if(d.data().uid === currentUser.uid || d.data().rombel === r) b = true; });
                if(!b) { await addDoc(collection(db, "jadwal"), { uid: currentUser.uid, hari:h, jam:j, rombel:r, fase:f }); m.innerText = "Sukses ditambah!"; } else m.innerText = "BENTROK DETECTED!";
            } else { m.innerText = "Mode Bypass: Jadwal ditambahkan (Lokal)"; } // Bypass simplify
        });

        function loadJadwal() {
            if(!isBypass) {
                onSnapshot(query(collection(db, "jadwal"), where("uid", "==", currentUser.uid)), (snap) => {
                    let h='', o='<option value="">Pilih Jadwal</option>'; 
                    snap.forEach(doc => { let d=doc.data(); let jsn=JSON.stringify(d); 
                        h+=`<tr><td>${d.hari}</td><td>Ke-${d.jam}</td><td>${d.rombel}</td><td>${d.fase}</td><td>Hapus</td></tr>`;
                        o+=`<option value='${jsn}'>${d.hari} Jam ${d.jam} - ${d.rombel}</option>`;
                    });
                    document.getElementById('tabelJadwalBody').innerHTML = h; document.getElementById('pSelectJadwal').innerHTML = o; document.getElementById('selectJadwalAbsen').innerHTML = o;
                });
            }
        }

        // ATP PROTA PROMES GENERATOR
        window.generateTahunan = function() {
            const fase = document.getElementById('tFase').value;
            let faseText = fase === 'A' ? 'Fase A (Kelas 1)' : fase === 'B' ? 'Fase B (Kelas 3)' : 'Fase C (Kelas 5)';
            document.querySelectorAll('.vFaseKelas').forEach(e => e.innerText = faseText);
            
            // Dummy Data Generator based on Kurikulum Merdeka PAI
            let atpHTML = '', protaHTML = '', promesHTML = '';
            const materi = [
                {bab: 1, judul: "Mari Belajar Al-Qur'an (Surah Pendek)", elemen: "Al-Qur'an Hadis", jp: 12},
                {bab: 2, judul: "Mengenal Rukun Iman & Asmaul Husna", elemen: "Akidah", jp: 12},
                {bab: 3, judul: "Berakhlak Terpuji & Mandiri", elemen: "Akhlak", jp: 8},
                {bab: 4, judul: "Menyambut Usia Balig (Fikih)", elemen: "Fikih", jp: 12},
                {bab: 5, judul: "Kisah Keteladanan Nabi", elemen: "Sejarah Islam", jp: 10}
            ];

            materi.forEach((m, i) => {
                // Build ATP
                atpHTML += `<tr><td>Ganjil</td><td>${m.elemen}</td><td>Peserta didik mampu memahami ${m.judul} dengan mengedepankan profil Kemandirian dan Penalaran Kritis.</td><td>${m.jp} JP</td></tr>`;
                // Build Prota
                protaHTML += `<tr><td>Ganjil</td><td>Bab ${m.bab}: ${m.judul}</td><td>${m.jp}</td><td>Dilaksanakan Sesuai Kalender</td></tr>`;
                // Build Promes (Spreading JP across weeks simply)
                promesHTML += `<tr><td>Bab ${m.bab}: ${m.judul}</td><td>${m.jp}</td>
                    <td>4</td><td>4</td><td>4</td><td style="background:#eee"></td> 
                    <td></td><td></td><td></td><td></td> <td></td><td></td><td></td><td></td> 
                    <td></td><td></td><td></td><td></td> <td></td><td></td><td></td><td></td> 
                    <td></td><td></td><td></td><td></td></tr>`;
            });

            document.getElementById('tblAtpBody').innerHTML = atpHTML;
            document.getElementById('tblProtaBody').innerHTML = protaHTML;
            document.getElementById('tblPromesBody').innerHTML = promesHTML;

            // Transfer generated content to Preview Area
            document.getElementById('printArea').innerHTML = ''; // clear 
            document.getElementById('previewTahunan').innerHTML = `
                <div class="alert alert-success">Berhasil di-generate untuk ${faseText}. Silakan klik tombol PDF di kanan atas untuk mencetak masing-masing dokumen.</div>
                <div class="border p-3 mt-2" style="transform: scale(0.8); transform-origin: top left;">
                    ${document.getElementById('tplATP').innerHTML}
                </div>`;
            
            // Re-assign IDs properly for printing targets
            document.getElementById('tplATP').id = "docATP";
            document.getElementById('tplProta').id = "docProta";
            document.getElementById('tplPromes').id = "docPromes";
        };

        // MODUL & LKPD
        window.generateModul = function() {
            const jVal = document.getElementById('pSelectJadwal').value; if(!jVal) return alert("Pilih Jadwal!");
            const j = JSON.parse(jVal); const b = document.getElementById('pBab').value;
            document.getElementById('outFase').innerText = `Fase ${j.fase}`; document.getElementById('outRombel').innerText = j.rombel;
            document.querySelectorAll('.vRombelPrint').forEach(e => e.innerText = j.rombel);
            document.querySelectorAll('.vBab').forEach(e => e.innerText = b);
            document.getElementById('outMateri').innerText = `Tujuan Pembelajaran Fase ${j.fase} Bab ${b}: Membentuk pemahaman mendalam tentang nilai PAI dan mengintegrasikan 8 Profil Lulusan.`;
            alert("Modul & LKPD disesuaikan!");
        };

        // ABSEN JURNAL
        window.loadAbsensi = function() {
            const jVal = document.getElementById('selectJadwalAbsen').value; if(!jVal) return alert("Pilih Jadwal!");
            const j = JSON.parse(jVal); const sKelas = dataSiswa.filter(s => s.kelas === j.rombel);
            document.getElementById('areaAbsen').classList.remove('d-none'); document.getElementById('labelKelasAbsen').innerText = j.rombel;
            if(sKelas.length === 0) return document.getElementById('listSiswaAbsen').innerHTML = '<div class="text-danger">Kosong. Import data kelas ini dulu.</div>';
            let h = ''; sKelas.forEach((s,i) => { h += `<div class="col-3"><input type="checkbox" class="absen-check" value="${s.nama}" checked> <span class="small">${s.nama}</span></div>`; });
            document.getElementById('listSiswaAbsen').innerHTML = h;
        };

        window.simpanJurnal = function() {
            const jVal = JSON.parse(document.getElementById('selectJadwalAbsen').value);
            const boxes = document.querySelectorAll('.absen-check'); let h=0, abs=[];
            boxes.forEach(b => { if(b.checked) h++; else abs.push(b.value); });
            document.getElementById('jurTanggal').innerText = new Date().toLocaleDateString('id-ID');
            document.getElementById('jurRombel').innerText = jVal.rombel; document.getElementById('jurJam').innerText = jVal.jam;
            document.getElementById('jurHadir').innerText = h; document.getElementById('jurAbsen').innerText = abs.length;
            document.getElementById('jurListAbsen').innerText = abs.length > 0 ? abs.join(", ") : "-";
            alert("Tersimpan ke Jurnal! Silakan Cetak PDF.");
        };
    </script>
</body>
</html>
