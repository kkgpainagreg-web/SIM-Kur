<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM Kurikulum Merdeka Terpadu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="data_default.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background-color: #1a252f; color: white; padding-top: 20px;}
        .sidebar .nav-link { color: #bdc3c7; cursor: pointer; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #2c3e50; border-radius: 5px; }
        .content-area { padding: 20px; height: 100vh; overflow-y: auto; }
        .badge-pro { background-color: #f1c40f; color: #2c3e50; font-size: 0.7em; padding: 3px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold;}
        
        .document-page { background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; font-family: 'Times New Roman', Times, serif; color: black;}
        .doc-header { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 15px; text-transform: uppercase; line-height: 1.3; }
        table.doc-table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-bottom: 15px; }
        table.doc-table th, table.doc-table td { border: 1px solid black; padding: 8px; vertical-align: middle; }
        table.doc-table th { background-color: #f8f9fa; text-align: center; font-weight: bold; }
        table.identity-table { width: 100%; margin-bottom: 15px; font-size: 11pt; }
        table.identity-table td { padding: 4px; vertical-align: top; }
        .signature-area { width: 100%; margin-top: 40px; display: table; page-break-inside: avoid; }
        .signature-box { display: table-cell; width: 50%; text-align: center; font-size: 11pt; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 75px; }

        @media print {
            @page { margin: 15mm; }
            body { background-color: white !important; margin: 0; padding: 0; }
            .no-print, .sidebar { display: none !important; }
            .content-area { width: 100% !important; padding: 0 !important; overflow: visible !important; height: auto !important; }
            .document-page { box-shadow: none !important; margin: 0 !important; padding: 0 !important; border: none !important; }
            .hide-on-print { display: none !important; }
            table.doc-table th { -webkit-print-color-adjust: exact; background-color: #e9ecef !important; }
            .landscape-print { @page { size: landscape; } }
            .portrait-print { @page { size: portrait; } }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-5 text-center shadow" style="max-width: 450px;">
            <h3 class="mb-3 text-primary fw-bold">üéì SIM Kurikulum Merdeka</h3>
            <p class="text-muted small">Kelola Modul, Jadwal, Nilai & Absen dengan Mudah.</p>
            <button id="btnLogin" class="btn btn-danger mt-3">üåê Sign in with Google / belajar.id</button>
            <button class="btn btn-outline-secondary mt-3 btn-sm" onclick="bypassLogin()">Mode Uji Coba (Lokal)</button>
        </div>
    </div>

    <div id="mainApp" class="container-fluid d-none">
        <div class="row">
            <div class="col-md-2 sidebar flex-column no-print">
                <div class="text-center mb-3">
                    <img id="userAvatar" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" class="rounded-circle mb-2 bg-secondary" width="50" height="50">
                    <div id="userName" class="small fw-bold">Memuat...</div>
                    <span id="userBadge" class="badge bg-secondary">FREE USER</span>
                    <div><button id="btnLogout" class="btn btn-sm btn-outline-light mt-2" style="font-size: 0.7rem;">Logout</button></div>
                </div>
                <hr class="bg-light">
                <nav class="nav flex-column">
                    <a id="navAdmin" class="nav-link text-danger fw-bold d-none mb-2 border-bottom border-danger" onclick="showTab('tabAdmin')">‚öôÔ∏è PANEL ADMIN</a>
                    
                    <a class="nav-link active" onclick="showTab('tabDashboard')">üè† Dashboard</a>
                    <a class="nav-link text-warning" onclick="showTab('tabProfil')">üè´ Profil & Instansi</a>
                    <a class="nav-link text-info" onclick="showTab('tabCPTP')">üéØ Setup CP & TP</a>
                    <a class="nav-link" onclick="showTab('tabSiswa')">üë• Data Siswa (CSV)</a>
                    <a class="nav-link" onclick="showTab('tabJadwal')">üìÖ Jadwal Mengajar</a>
                    <a class="nav-link" onclick="showTab('tabTahunan')">üìÅ Prota, Promes, ATP</a>
                    
                    <a class="nav-link text-muted" onclick="showTab('tabPerangkat')">üìñ Modul & LKPD <span class="badge-pro">PRO</span></a>
                    <a class="nav-link text-muted" onclick="showTab('tabPelaksanaan')">üìã Absen & Jurnal <span class="badge-pro">PRO</span></a>
                    <a class="nav-link text-muted" onclick="showTab('tabPenilaian')">üìà Rekap Penilaian <span class="badge-pro">PRO</span></a>
                    <a class="nav-link text-primary fw-bold" onclick="showTab('tabAI')">ü§ñ Asisten AI <span class="badge-pro">PRO</span></a>
                    
                    <hr class="bg-light my-2">
                    <a class="nav-link text-success fw-bold" onclick="showTab('tabPanduan')">üìñ BUKU PANDUAN</a>
                </nav>
            </div>

            <div class="col-md-10 content-area" id="mainContentArea">
                
                <div id="tabLocked" class="tab-content d-none">
                    <div class="card p-5 text-center shadow-sm border-warning mt-5 mx-auto" style="max-width: 600px;">
                        <h1 style="font-size: 3rem;">üîí</h1>
                        <h3 class="text-warning fw-bold">Akses Terkunci (Fitur PRO)</h3>
                        <p class="mt-3">Maaf, fitur ini hanya tersedia untuk pengguna <b>Akun PRO</b>. Upgrade sekarang untuk membuka akses ke:</p>
                        <ul class="text-start mx-auto w-75 text-muted">
                            <li>Modul Ajar & LKPD Otomatis</li>
                            <li>Jurnal Mengajar & Presensi</li>
                            <li>Sistem Rekapitulasi Nilai Siswa</li>
                            <li>Template Prompt Asisten AI</li>
                        </ul>
                        <a id="btnUpgradeWa" href="#" target="_blank" class="btn btn-success mt-4 fw-bold fs-5 py-2">
                            üì± Hubungi Admin via WhatsApp
                        </a>
                        <p class="small text-muted mt-3">Silakan lampirkan email Google Anda saat menghubungi admin.</p>
                    </div>
                </div>

                <div id="tabAdmin" class="tab-content d-none">
                    <h3 class="mb-4 text-danger fw-bold">‚öôÔ∏è Panel Administrator</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-4 shadow-sm border-danger mb-3">
                                <h5>Pengaturan WhatsApp Upgrade</h5>
                                <p class="small text-muted">Nomor WA yang dihubungi user jika ingin upgrade ke PRO. Gunakan format 628xxx.</p>
                                <input type="text" id="adminWaInput" class="form-control mb-2" placeholder="628123456789">
                                <button class="btn btn-danger w-100" onclick="saveAdminSettings()">Simpan Pengaturan</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-4 shadow-sm border-primary">
                                <h5>Upgrade User Secara Manual</h5>
                                <p class="small text-muted">Masukkan UID akun user (Firebase UID) untuk mengubah status akunnya menjadi PRO.</p>
                                <input type="text" id="adminUidInput" class="form-control mb-2" placeholder="Masukkan UID User">
                                <button class="btn btn-primary w-100" onclick="upgradeUserToPro()">Jadikan PRO</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabDashboard" class="tab-content">
                    <h3 class="mb-4">Sistem Manajemen Kurikulum Merdeka</h3>
                    <div class="alert alert-info shadow-sm">
                        <h5 class="fw-bold">Selamat Datang!</h5>
                        <p>Akun Anda saat ini adalah: <b id="dashUserStatus" class="text-uppercase text-danger">FREE</b>.</p>
                        <p>Sebagai pengguna Free, Anda tetap dapat membuat <b>Jadwal Anti-Bentrok</b>, serta mencetak <b>ATP, Prota, dan Promes</b> secara gratis selamanya.</p>
                    </div>
                </div>

                <div id="tabPanduan" class="tab-content d-none no-print">
                    <h3 class="mb-3">üìñ Buku Panduan</h3>
                    <div class="card p-4 shadow-sm" style="line-height: 1.7;">
                        <h5 class="fw-bold text-primary">Cara Penggunaan (Free & Pro)</h5>
                        <p>Aplikasi ini memungkinkan Anda mengatur kelas, materi, dan jadwal dengan mudah. Semua tab yang memiliki logo <span class="badge-pro">PRO</span> di sidebar memerlukan upgrade akun. Silakan klik tab tersebut dan hubungi admin melalui tombol WhatsApp yang disediakan.</p>
                        <p>Jika Anda Guru PAI, masuk ke menu <b>Setup CP & TP</b> lalu klik tombol "Load Data" untuk memuat materi Kelas 1-6 SD secara otomatis.</p>
                    </div>
                </div>

                <div id="printArea" class="d-none"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Konfigurasi Anda
        const firebaseConfig = { apiKey: "AIzaSyCTEbggjJ5cguXAlq-QpbY5mO2G16S7rvQ", authDomain: "si-gumart.firebaseapp.com", projectId: "si-gumart", storageBucket: "si-gumart.firebasestorage.app", messagingSenderId: "544375918988", appId: "1:544375918988:web:a8459825c68810f22546a9" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = { isPro: false };
        let isAdmin = false;
        let adminWaNumber = "628123456789"; // Default

        const proTabs = ['tabPerangkat', 'tabPelaksanaan', 'tabPenilaian', 'tabAI'];

        // Core Navigation with Freemium Logic
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            // Check Lock
            if (proTabs.includes(tabId) && !userData.isPro && !isAdmin) {
                document.getElementById('tabLocked').classList.remove('d-none');
                const textWa = `Halo Admin, saya ingin upgrade akun SIM Kurikulum Merdeka menjadi PRO. Email saya: ${currentUser ? currentUser.email : 'Lokal'}`;
                document.getElementById('btnUpgradeWa').href = `https://wa.me/${adminWaNumber}?text=${encodeURIComponent(textWa)}`;
            } else {
                document.getElementById(tabId).classList.remove('d-none');
                
                // Trigger renders
                if(tabId === 'tabCPTP' && typeof renderCPTP === 'function') renderCPTP();
            }

            // Set Active Sidebar
            const evtTarget = event ? event.target.closest('a') : null;
            if(evtTarget) evtTarget.classList.add('active');
        };

        // AUTH & DATABASE LOGIC
        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => alert(e.message)));
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth).then(()=> location.reload()));
        
        window.bypassLogin = function() {
            currentUser = { uid: "local_bypass", email: "lokal@test.com", displayName: "User Uji Coba" };
            userData = { isPro: false };
            handleLoginSuccess();
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // 1. Check/Create User Document
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    userData = userSnap.data();
                } else {
                    userData = { email: user.email, name: user.displayName, isPro: false };
                    await setDoc(userRef, userData);
                }

                // 2. Admin Check
                if (user.email === "afifaro@gmail.com") {
                    isAdmin = true;
                    userData.isPro = true; // Admin is always pro
                    document.getElementById('navAdmin').classList.remove('d-none');
                }

                // 3. Fetch App Settings (WA Number)
                const setRef = doc(db, "settings", "app");
                const setSnap = await getDoc(setRef);
                if (setSnap.exists()) {
                    adminWaNumber = setSnap.data().waNumber || "628123456789";
                    if(isAdmin) document.getElementById('adminWaInput').value = adminWaNumber;
                }

                handleLoginSuccess();
            } else {
                document.getElementById('loginScreen').classList.remove('d-none');
                document.getElementById('mainApp').classList.add('d-none');
            }
        });

        function handleLoginSuccess() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('mainApp').classList.remove('d-none');
            document.getElementById('userName').innerText = currentUser.displayName;
            if(currentUser.photoURL) document.getElementById('userAvatar').src = currentUser.photoURL;
            
            // UI Status Update
            const badge = document.getElementById('userBadge');
            const dashText = document.getElementById('dashUserStatus');
            if(isAdmin) { badge.innerText = "ADMIN"; badge.className = "badge bg-danger"; dashText.innerText = "ADMINISTRATOR"; }
            else if (userData.isPro) { badge.innerText = "PRO USER"; badge.className = "badge bg-warning text-dark"; dashText.innerText = "PRO PREMIUM"; }
            else { badge.innerText = "FREE USER"; badge.className = "badge bg-secondary"; dashText.innerText = "FREE"; }
        }

        // ADMIN FUNCTIONS
        window.saveAdminSettings = async function() {
            if(!isAdmin) return;
            const wa = document.getElementById('adminWaInput').value;
            await setDoc(doc(db, "settings", "app"), { waNumber: wa }, {merge: true});
            adminWaNumber = wa;
            alert("Nomor WA Upgrade berhasil disimpan!");
        };

        window.upgradeUserToPro = async function() {
            if(!isAdmin) return;
            const uid = document.getElementById('adminUidInput').value.trim();
            if(!uid) return alert("Masukkan UID!");
            try {
                await updateDoc(doc(db, "users", uid), { isPro: true });
                alert("Berhasil! User dengan UID tersebut sekarang adalah PRO.");
                document.getElementById('adminUidInput').value = '';
            } catch(e) {
                alert("Gagal. Pastikan UID benar dan user pernah login sebelumnya.\nError: " + e.message);
            }
        };

               // Import CSV Siswa
        function processCsvData(d) {
            let hitung = 0;
            d.forEach(s => {
                let nisn=s.nisn||s.NISN, nm=s.nama||s.Nama, jk=s.jk||s.JK, kls=s.kelas||s.Kelas, rmb=s.rombel||s.Rombel;
                if(nm && kls && rmb) { dataSiswa.push({ nisn: nisn||'-', nama: nm, jk: jk||'-', kelas: kls, rombel: rmb }); hitung++; }
            });
            localStorage.setItem('sim_siswa', JSON.stringify(dataSiswa)); renderTabelSiswa(); alert(`${hitung} siswa diimport!`);
        }
        window.importSiswaLokal = function() {
            const f = document.getElementById('fileCsvSiswa').files[0]; if(!f) return alert("Pilih file CSV!");
            Papa.parse(f, { header: true, skipEmptyLines: true, complete: function(r) { processCsvData(r.data); }});
        };
        window.clearDataSiswa = function() { if(confirm("Hapus semua?")){ dataSiswa=[]; localStorage.removeItem('sim_siswa'); renderTabelSiswa();} }
        window.renderTabelSiswa = function() {
            const f = document.getElementById('filterKelasSiswa').value;
            let opt = '<option value="ALL">-- Semua Rombel --</option>';
            new Set(dataSiswa.map(s => s.rombel)).forEach(r => opt += `<option value="${r}" ${f===r?'selected':''}>${r}</option>`);
            document.getElementById('filterKelasSiswa').innerHTML = opt;
            let tb = ''; (f==="ALL"?dataSiswa:dataSiswa.filter(s=>s.rombel===f)).forEach(s => tb += `<tr><td>${s.nisn}</td><td>${s.nama}</td><td>${s.jk}</td><td>${s.kelas}</td><td>${s.rombel}</td></tr>`);
            document.getElementById('tabelSiswaBody').innerHTML = tb || '<tr><td colspan="5" class="text-center">Kosong</td></tr>';
        };

        // Jadwal (Lokal Storage)
        window.tambahJadwalLokal = function() {
            const h = document.getElementById('jadwalHari').value, j = document.getElementById('jadwalJam').value, f = document.getElementById('jadwalFase').value, r = document.getElementById('jadwalRombel').value;
            if(!j || !r) return alert("Jam & Rombel wajib isi!");
            dataJadwal.push({ hari:h, jam:j, fase:f, rombel:r });
            localStorage.setItem('sim_jadwal', JSON.stringify(dataJadwal)); renderJadwal();
        }
        window.hapusJadwal = function(idx) { dataJadwal.splice(idx,1); localStorage.setItem('sim_jadwal', JSON.stringify(dataJadwal)); renderJadwal(); }
        function renderJadwal() {
            let tb = ''; dataJadwal.forEach((d,i) => tb+=`<tr><td>${d.hari}</td><td>Ke-${d.jam}</td><td>${d.fase}</td><td>${d.rombel}</td><td><button class="btn btn-sm btn-danger" onclick="hapusJadwal(${i})">Hapus</button></td></tr>`);
            document.getElementById('tabelJadwalBody').innerHTML = tb;
        }

        // Helper Dropdown UI
        function populateDropdowns() {
            let oj = '<option value="">-- Pilih Jadwal/Rombel --</option>';
            dataJadwal.forEach((d) => oj += `<option value='${JSON.stringify(d)}'>${d.hari} Jam ${d.jam} - Rombel ${d.rombel}</option>`);
            document.querySelectorAll('#pSelectJadwal, #selectJadwalAbsen').forEach(el => el.innerHTML = oj);
            let ot = '<option value="">-- Pilih Materi (TP) --</option>';
            dataCPTP.tps.forEach(t => ot += `<option value='${t.judul}'>Bab ${t.bab} - ${t.judul}</option>`);
            document.querySelectorAll('#pSelectTP, #selectTPAbsen').forEach(el => el.innerHTML = ot);
        }
        function populateFaseRombelOptions(elementId) {
            let setFr = new Set(dataJadwal.map(d => `Fase ${d.fase} - ${d.rombel}`));
            let o = ''; setFr.forEach(fr => o += `<option value="${fr}">${fr}</option>`);
            document.getElementById(elementId).innerHTML = o || '<option value="">Buat Jadwal Dulu</option>';
        }

        // Generator Tahunan
        window.generateTahunan = function() {
            const fr = document.getElementById('tFaseRombel').value;
            document.querySelectorAll('.vFaseRombel').forEach(el => el.innerText = fr);
            document.getElementById('vCPATP').innerText = dataCPTP.cp;

            let hatp='', hprota='', hpromes='';
            dataCPTP.tps.forEach(t => {
                hatp += `<tr><td>${t.bab}</td><td>Peserta didik mampu memahami: ${t.judul}</td><td>${t.jp} JP</td></tr>`;
                hprota += `<tr><td>Ganjil</td><td>Bab ${t.bab} - ${t.judul}</td><td>${t.jp}</td><td>Sesuai Kalender</td></tr>`;
                hpromes += `<tr><td>Bab ${t.bab}: ${t.judul}</td><td>${t.jp}</td><td>${Math.ceil(t.jp/2)}</td><td>${Math.floor(t.jp/2)}</td><td></td><td></td> <td></td><td></td><td></td><td></td> <td></td><td></td><td></td><td></td> <td></td><td></td><td></td><td></td></tr>`;
            });
            document.getElementById('tblAtpBody').innerHTML = hatp; document.getElementById('tblProtaBody').innerHTML = hprota; document.getElementById('tblPromesBody').innerHTML = hpromes;
            alert("Data di-load! Silakan klik tombol Cetak.");
        }

        // Generator Modul
        window.generateModul = function() {
            const j = document.getElementById('pSelectJadwal').value; const tp = document.getElementById('pSelectTP').value;
            if(!j || !tp) return alert("Pilih Jadwal & Materi!"); const jv = JSON.parse(j);
            document.querySelectorAll('.vFaseRombel').forEach(e => e.innerText = `Fase ${jv.fase} / ${jv.rombel}`);
            document.getElementById('outMateriModul').innerText = tp;
            alert("Modul Siap! Klik Cetak.");
        }

        // Absensi
        window.loadAbsensi = function() {
            const jVal = document.getElementById('selectJadwalAbsen').value; if(!jVal) return alert("Pilih Jadwal!");
            const rmb = JSON.parse(jVal).rombel; const sKelas = dataSiswa.filter(s => s.rombel === rmb);
            document.getElementById('areaAbsen').classList.remove('d-none');
            let h = ''; sKelas.forEach(s => h += `<div class="col-3"><input type="checkbox" class="absen-check" value="${s.nama}" checked> <span class="small">${s.nama}</span></div>`);
            document.getElementById('listSiswaAbsen').innerHTML = h || '<div class="text-danger">Siswa kosong di rombel ini. Import Data Dulu.</div>';
        };
        window.simpanJurnal = function() {
            const jVal = JSON.parse(document.getElementById('selectJadwalAbsen').value); const mt = document.getElementById('selectTPAbsen').value;
            const boxes = document.querySelectorAll('.absen-check'); let h=0, abs=[];
            boxes.forEach(b => { if(b.checked) h++; else abs.push(b.value); });
            document.getElementById('jurTanggal').innerText = new Date().toLocaleDateString('id-ID');
            document.getElementById('jurRombel').innerText = jVal.rombel; document.getElementById('jurMateri').innerText = mt;
            document.getElementById('jurHadir').innerText = h; document.getElementById('jurAbsen').innerText = abs.length;
            document.getElementById('jurListAbsen').innerText = abs.length > 0 ? abs.join(", ") : "-";
            alert("Tersimpan! Silakan klik Cetak Jurnal.");
        };

        // Penilaian
        window.renderKelasPenilaian = function() {
            let o = '<option value="">-- Pilih Rombel --</option>'; new Set(dataSiswa.map(s => s.rombel)).forEach(k => o += `<option value="${k}">${k}</option>`);
            document.getElementById('selectKelasNilai').innerHTML = o;
        };
        window.loadPenilaian = function() {
            const rmb = document.getElementById('selectKelasNilai').value;
            document.getElementById('lblKelasNilai').innerText = rmb; document.getElementById('lblTopikNilai').innerText = document.getElementById('topikNilai').value;
            let tb = '';
            dataSiswa.filter(s => s.rombel === rmb).forEach((s, i) => {
                let v = dataNilai[`${rmb}_${s.nisn}`] || '';
                tb += `<tr><td>${i+1}</td><td>${s.nisn}</td><td class="text-start">${s.nama}</td><td>${s.jk}</td>
                <td class="no-print"><input type="number" class="form-control input-nilai text-center" data-id="${s.nisn}" value="${v}"></td>
                <td class="hide-on-print print-only-td" style="display:none;">${v}</td></tr>`;
            });
            tb += `<style>@media print { .input-nilai { display: none !important; } .print-only-td { display: table-cell !important; } }</style>`;
            document.getElementById('tblNilaiBody').innerHTML = tb || '<tr><td colspan="5">Pilih Rombel.</td></tr>';
            document.getElementById('docNilai').classList.remove('d-none');
        };
        window.simpanNilai = function() {
            const rmb = document.getElementById('selectKelasNilai').value; if(!rmb) return alert("Pilih rombel!");
            document.querySelectorAll('.input-nilai').forEach(el => dataNilai[`${rmb}_${el.getAttribute('data-id')}`] = el.value);
            localStorage.setItem('sim_nilai', JSON.stringify(dataNilai)); alert("Nilai Disimpan!"); loadPenilaian();
        };

        // Initialize App
        window.onload = function() { loadProfil(); renderTabelSiswa(); renderJadwal(); renderCPTP(); };

    </script>
</body>
</html>
