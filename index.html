<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Perangkat Pembelajaran Universal (Cloud Mode)</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --sidebar-bg: #0f172a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-main); font-size: 11pt; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR (Kiri) --- */
        .sidebar {
            width: 340px; min-width: 340px; background-color: var(--sidebar-bg); color: white;
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 100;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .header-app { border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 5px; }
        .header-app h2 { font-size: 1.3rem; color: #fbbf24; margin-bottom: 5px; line-height: 1.3; }
        .header-app p { font-size: 0.8rem; color: #94a3b8; }
        
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; color: #cbd5e1; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px 10px; border: 1px solid #475569; border-radius: 6px; font-size: 0.9rem; 
            background-color: #1e293b; color: white; transition: 0.2s; font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #fbbf24; }
        
        .btn-action {
            padding: 10px; background-color: #10b981; color: white; border: none; border-radius: 6px; 
            cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s; text-align: center;
        }
        .btn-action:hover { background-color: #059669; }
        
        .btn-print {
            padding: 12px; font-size: 1rem; position: sticky; bottom: 0; margin-top: 10px; 
            box-shadow: 0 -4px 10px rgba(15, 23, 42, 0.8); background-color: #3b82f6;
        }
        .btn-print:hover { background-color: #2563eb; }
        
        .btn-danger { background-color: #ef4444; color: white; padding: 6px; font-size: 0.8rem; margin-top: 5px;}
        .btn-danger:hover { background-color: #dc2626; }
        
        .btn-help { background-color: #3b82f6; color: white; font-size: 0.8rem; padding: 6px; margin-top: -5px; margin-bottom: 10px;}
        .btn-help:hover { background-color: #2563eb; }

        .csv-info { padding: 10px; background-color: #047857; border-radius: 6px; font-size: 0.8rem; display: none; margin-top: 5px; line-height: 1.4;}
        .csv-info.error { background-color: #991b1b; }
        .divider { height: 1px; background-color: #334155; margin: 5px 0; }

        .cloud-box { border: 1px dashed #fbbf24; padding: 12px; border-radius: 8px; background-color: rgba(251, 191, 36, 0.05); }

        /* --- MODAL PANDUAN --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; color: #1e293b; width: 700px; max-width: 90%; border-radius: 10px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; color: var(--primary); }
        .modal-close { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; float: right; font-weight: bold; }

        /* --- MAIN CONTENT (Kanan) --- */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; background-color: #e2e8f0; scroll-behavior: smooth; }
        .document-container { max-width: 297mm; margin: 0 auto; display: flex; flex-direction: column; gap: 30px; }
        
        .page { background-color: var(--card-bg); padding: 15mm; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow-x: auto; position: relative; }
        .page.landscape { max-width: 297mm; min-height: 210mm; }
        .page.portrait { max-width: 210mm; min-height: 297mm; margin: 0 auto; }
        
        .editable { cursor: text; transition: all 0.2s; border-radius: 4px; padding: 2px;}
        .editable:hover, [contenteditable="true"]:hover { background-color: #fef08a; outline: 1px dashed #eab308; color: #000;}

        /* --- TYPOGRAPHY & TABLES --- */
        .header-title { text-align: center; font-weight: bold; font-size: 13pt; margin-bottom: 15px; text-transform: uppercase; }
        .identity-table { width: 100%; margin-bottom: 15px; font-size: 11pt; font-weight: bold;}
        .identity-table td { padding: 2px; vertical-align: top; }
        
        table.data-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 10pt; }
        table.data-table th, table.data-table td { border: 1px solid #000; padding: 6px; vertical-align: middle; text-align: center; }
        table.data-table th { background-color: #f1f5f9; font-weight: bold; }
        table.data-table td.text-left { text-align: left; }
        
        .cell-date { font-size: 7.5pt; color: #c0392b; display: block; margin-top: 2px; }
        .cell-jp { font-size: 10pt; font-weight: bold; color: #0f172a; }

        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; vertical-align: middle; margin: auto; }
        .vertical-event { writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; vertical-align: middle; margin: auto; font-size: 8.5pt; letter-spacing: 1.5px; color: #334155; white-space: nowrap; }

        .kktp-val { background-color: #fdfde8; font-weight: bold; color: var(--primary);}
        .kktp-hasil { background-color: #e0f2fe; color: var(--secondary); font-size: 11pt;}

        .signature-area { width: 100%; margin-top: 30px; display: table; page-break-inside: avoid; }
        .signature-box { display: table-cell; width: 50%; text-align: center; font-size: 11pt; vertical-align: bottom; }
        .signature-box.right { text-align: right; padding-right: 30px; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 70px; }

        /* --- MODUL & LKPD SPECIFIC --- */
        .section-title { font-weight: bold; font-size: 11pt; margin-top: 15px; margin-bottom: 5px; background-color: #e2e8f0; padding: 4px 8px; border-left: 4px solid var(--primary); }
        .content-body { text-align: justify; margin-bottom: 10px; padding-left: 10px; }
        .content-body ul, .content-body ol { padding-left: 20px; margin-top: 5px; }
        .content-body li { margin-bottom: 4px; }
        
        .lkpd-box { border: 2px dashed var(--primary); border-radius: 10px; padding: 20px; background-color: #f8fafc; height: 100%;}
        .lkpd-header { font-size: 16pt; font-weight: bold; text-align: center; color: var(--secondary); margin-bottom: 15px; }
        .lkpd-identity { display: flex; gap: 20px; margin-bottom: 20px; font-weight: bold; }
        .lkpd-identity div { flex: 1; border-bottom: 1px solid #000; padding-bottom: 5px; }

        @media print {
            body { display: block; height: auto; overflow: visible; background-color: white; }
            .sidebar, .modal-overlay { display: none !important; }
            .main-content { padding: 0; background-color: white; }
            .document-container { gap: 0; }
            .page { margin: 0; box-shadow: none; border-radius: 0; padding: 15mm; page-break-after: always; max-width: 100%; }
            .page:last-child { page-break-after: auto; }
            .editable:hover, [contenteditable="true"]:hover { background-color: transparent; outline: none; }
            table.data-table th { background-color: #e2e8f0 !important; -webkit-print-color-adjust: exact; }
            .kktp-val { background-color: transparent !important; color: black; }
            .kktp-hasil { background-color: #e0f2fe !important; -webkit-print-color-adjust: exact; }
            @page { size: A4 portrait; }
        }
    </style>
</head>
<body>

    <div class="modal-overlay" id="modalPanduan">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">Tutup ‚úñ</button>
            <div class="modal-header">‚òÅÔ∏è Panduan Link CSV Online (Google Sheets)</div>
            <p>Anda kini dapat memuat data langsung dari Google Sheets tanpa perlu download file!</p>
            <ol style="margin-left:20px; margin-bottom:15px; line-height:1.6;">
                <li>Buka file Google Sheets Anda yang berisi data ATP/CP (Pastikan format 7 kolom).</li>
                <li>Pilih menu <strong>File > Bagikan (Share) > Publikasikan ke web (Publish to web)</strong>.</li>
                <li>Pada kotak dialog, pilih <strong>Dokumen Seluruhnya</strong> atau <strong>Sheet Tertentu (misal: cp-pai-sd)</strong>.</li>
                <li>Pada dropdown format, ubah "Halaman Web" menjadi <strong>Nilai yang dipisahkan koma (.csv)</strong>.</li>
                <li>Klik <strong>Publikasikan</strong> dan salin Link yang muncul.</li>
                <li>Paste link tersebut ke dalam kotak <strong>"Link CSV Google Sheets"</strong> di aplikasi ini, lalu klik Muat.</li>
            </ol>
            <p style="color:#ef4444; font-size:0.9rem;"><strong>Catatan:</strong> Jika Anda memiliki banyak sheet (misal Sheet SD, SMP, SMA), Anda harus mempublikasikan dan menyalin link untuk <strong>masing-masing sheet</strong> tersebut secara terpisah, karena 1 link CSV hanya bisa memuat 1 sheet data.</p>
        </div>
    </div>

    <div class="sidebar no-print">
        <div class="header-app">
            <h2>‚òÅÔ∏è Cloud Gen-Perangkat</h2>
            <button class="btn-action btn-help" onclick="openModal()">üìñ Cara Dapat Link CSV Google Sheets</button>
        </div>

        <div class="cloud-box">
            <div class="form-group">
                <label style="color:#fbbf24;">üåê Link CSV Google Sheets (Permanen)</label>
                <textarea id="inputUrlCsv" rows="3" placeholder="Paste link Google Sheets (Publikasikan ke Web sbg CSV) di sini..."></textarea>
            </div>
            <button class="btn-action" style="width:100%; margin-top:10px;" onclick="fetchAndSaveCSV()">‚òÅÔ∏è Simpan & Muat Data</button>
            <button class="btn-action btn-danger" style="width:100%;" onclick="hapusUrlCSV()">üóëÔ∏è Hapus Link</button>
            
            <div id="csvStatus" class="csv-info"></div>
        </div>

        <div class="divider"></div>
        <div style="text-align: center; color: #94a3b8; font-size: 0.8rem;">--- ATAU UPLOAD MANUAL ---</div>

        <div class="form-group">
            <input type="file" id="fileCsv" accept=".csv" style="background:#475569;">
        </div>

        <div class="divider"></div>

        <div class="form-group">
            <label>Mata Pelajaran</label>
            <input type="text" id="inputMapel" value="Pendidikan Agama Islam dan Budi Pekerti" oninput="generateSemua()" style="font-weight: bold; color: #fbbf24;">
        </div>

        <div style="display: flex; gap: 8px;">
            <div class="form-group" style="flex: 1.2;">
                <label>Kelas</label>
                <select id="inputKelas" onchange="updateMateriList(); generateSemua();">
                    <option value="1">1 (Fase A)</option>
                    <option value="2">2 (Fase A)</option>
                    <option value="3">3 (Fase B)</option>
                    <option value="4">4 (Fase B)</option>
                    <option value="5">5 (Fase C)</option>
                    <option value="6" selected>6 (Fase C)</option>
                    <option value="7">7 (Fase D)</option>
                    <option value="8">8 (Fase D)</option>
                    <option value="9">9 (Fase D)</option>
                    <option value="10">10 (Fase E)</option>
                    <option value="11">11 (Fase F)</option>
                    <option value="12">12 (Fase F)</option>
                </select>
            </div>
            <div class="form-group" style="flex: 0.8;">
                <label>Rombel</label>
                <input type="text" id="inputRombel" value="A" oninput="generateSemua()" style="text-align: center;">
            </div>
            <div class="form-group" style="flex: 1.5;">
                <label>Semester</label>
                <select id="inputSemester" onchange="updateMateriList(); generateSemua();">
                    <option value="Ganjil" selected>Ganjil</option>
                    <option value="Genap">Genap</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Pilih Bab (Untuk Modul & LKPD)</label>
            <select id="inputElemen" onchange="generateSemua();">
                <option value="">- Memuat Data... -</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
                <label>Tahun Awal</label>
                <input type="number" id="inputTahunNum" value="2024" onchange="generateSemua()">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>JP / Pertemuan</label>
                <input type="number" id="inputJpPertemuan" value="4" onchange="generateSemua()">
            </div>
        </div>

        <div class="form-group">
            <label>Hari Mengajar</label>
            <select id="inputHari" onchange="generateSemua()">
                <option value="1" selected>Senin</option>
                <option value="2">Selasa</option>
                <option value="3">Rabu</option>
                <option value="4">Kamis</option>
                <option value="5">Jum'at</option>
                <option value="6">Sabtu</option>
            </select>
        </div>

        <div class="divider"></div>

        <div class="form-group">
            <label>Nama Sekolah</label>
            <input type="text" id="inputSekolah" value="SD Negeri Cerdas Bangsa" oninput="generateSemua()">
        </div>
        <div class="form-group">
            <label>Tempat, Tanggal Penetapan</label>
            <input type="text" id="inputTempatTgl" value="Jakarta, ........................ 2024" oninput="generateSemua()">
        </div>
        <div class="form-group">
            <label>Nama Kepala Sekolah</label>
            <input type="text" id="inputKepsek" value="Nama Kepsek, S.Pd., M.Pd." oninput="generateSemua()">
        </div>
        <div class="form-group">
            <label>NIP Kepala Sekolah</label>
            <input type="text" id="inputNipKepsek" value="19800101 200501 1 001" oninput="generateSemua()">
        </div>
        <div class="form-group">
            <label>Nama Guru Mata Pelajaran</label>
            <input type="text" id="inputGuru" value="Nama Guru, S.Pd." oninput="generateSemua()">
        </div>
        <div class="form-group">
            <label>NIP Guru</label>
            <input type="text" id="inputNipGuru" value="19900202 201502 2 002" oninput="generateSemua()">
        </div>

        <div class="form-group">
            <label style="color:#38bdf8;">Tgl Libur Khusus (YYYY-MM-DD)</label>
            <textarea id="inputLibur" rows="2" placeholder="Pisahkan dgn koma" onchange="generateSemua()"></textarea>
        </div>

        <button class="btn-action btn-print" onclick="window.print()">üñ®Ô∏è Cetak / Simpan PDF</button>
    </div>

    <div class="main-content">
        <div class="document-container">
            
            <div class="page landscape" id="pageAtp" style="max-width: 100%;">
                <div class="header-title" contenteditable="true" style="margin-bottom: 20px;">
                    ALUR BAHAN AJAR CP, TP DAN ATP<br>TAHUN PELAJARAN <span class="valTahun"></span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 11pt;" contenteditable="true">
                    <table style="text-align: left; line-height: 1.5;">
                        <tr><td width="160">NAMA SEKOLAH</td><td>: <span class="valSekolah"></span></td></tr>
                        <tr><td>MATA PELAJARAN</td><td>: <span class="valMapel"></span></td></tr>
                        <tr><td>FASE</td><td>: <span class="valFaseHuruf"></span></td></tr>
                    </table>
                    <table style="text-align: left; line-height: 1.5;">
                        <tr><td width="100">KELAS</td><td>: <span class="valKelasNum"></span></td></tr>
                        <tr><td>SEMESTER</td><td>: <span class="valSemester"></span></td></tr>
                    </table>
                </div>

                <table class="data-table" style="font-size: 8.5pt;">
                    <thead>
                        <tr>
                            <th width="3%">NO</th>
                            <th width="17%">ELEMEN DAN CAPAIAN PEMBELAJARAN</th>
                            <th width="12%">TUJUAN PEMBELAJARAN</th>
                            <th width="20%">ALUR TUJUAN PEMBELAJARAN FASE <span class="valFaseHuruf"></span> KELAS <span class="valKelasNum"></span> SMT <span class="valSemester"></span></th>
                            <th width="14%">DIMENSI PROFIL LULUSAN</th>
                            <th width="10%">KOMPETENSI</th>
                            <th width="10%">LINGKUP MATERI</th>
                            <th width="8%">WAKTU</th>
                            <th width="6%">KET.</th>
                        </tr>
                    </thead>
                    <tbody id="bodyAtp">
                        <tr><td colspan="9">Mempersiapkan data...</td></tr>
                    </tbody>
                </table>

                <div class="signature-area" contenteditable="true">
                    <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name valKepsek"></div>NIP. <span class="valNipKepsek"></span></div>
                    <div class="signature-box right"><span class="valTempatTgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name valGuru"></div>NIP. <span class="valNipGuru"></span></div>
                </div>
            </div>

            <div class="page portrait" id="pageProta">
                <div class="header-title" contenteditable="true">PROGRAM TAHUNAN (PROTA)<br><span class="valMapel" style="text-transform: uppercase;"></span></div>
                <table class="identity-table" contenteditable="true">
                    <tr><td width="180">Satuan Pendidikan</td><td width="10">:</td><td><span class="valSekolah"></span></td></tr>
                    <tr><td>Mata Pelajaran</td><td>:</td><td><span class="valMapel"></span></td></tr>
                    <tr><td>Fase / Kelas / Rombel</td><td>:</td><td><span class="valFase"></span> / <span class="valKelasNum"></span> / <span class="valRombel"></span></td></tr>
                    <tr><td>Tahun Pelajaran</td><td>:</td><td><span class="valTahun"></span></td></tr>
                </table>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th width="8%">Smt</th>
                            <th width="12%">Bab / Elemen</th>
                            <th width="70%">Tujuan Pembelajaran (Capaian)</th>
                            <th width="10%">JP</th>
                        </tr>
                    </thead>
                    <tbody id="bodyProta">
                        <tr><td colspan="4">Mempersiapkan data...</td></tr>
                    </tbody>
                </table>
                
                <div class="signature-area" contenteditable="true">
                    <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name valKepsek"></div>NIP. <span class="valNipKepsek"></span></div>
                    <div class="signature-box right"><span class="valTempatTgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name valGuru"></div>NIP. <span class="valNipGuru"></span></div>
                </div>
            </div>

            <div class="page landscape" id="pagePromes" style="max-width: 100%;">
                <div class="header-title" contenteditable="true">PROGRAM SEMESTER (PROSEM)<br>SEMESTER <span class="valSemester"></span></div>
                <table class="identity-table" contenteditable="true" style="width: 50%;">
                    <tr><td width="180">Satuan Pendidikan</td><td width="10">:</td><td><span class="valSekolah"></span></td></tr>
                    <tr><td>Mata Pelajaran</td><td>:</td><td><span class="valMapel"></span></td></tr>
                    <tr><td>Fase / Kelas / Rombel</td><td>:</td><td><span class="valFase"></span> / <span class="valKelasNum"></span> / <span class="valRombel"></span></td></tr>
                    <tr><td>Tahun Pelajaran</td><td>:</td><td><span class="valTahun"></span></td></tr>
                </table>

                <table class="data-table" style="font-size: 8.5pt;">
                    <thead id="headPromes"></thead>
                    <tbody id="bodyPromes">
                        <tr><td colspan="33">Mempersiapkan data...</td></tr>
                    </tbody>
                </table>

                <div class="signature-area" contenteditable="true">
                    <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name valKepsek"></div>NIP. <span class="valNipKepsek"></span></div>
                    <div class="signature-box right"><span class="valTempatTgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name valGuru"></div>NIP. <span class="valNipGuru"></span></div>
                </div>
            </div>

            <div class="page portrait" id="pageModul">
                <div class="header-title" contenteditable="true">MODUL AJAR KURIKULUM MERDEKA<br><span style="font-size:11pt; font-weight:normal;">Pendekatan Mindful, Meaningful, & Joyful Learning</span></div>
                
                <div class="section-title">A. IDENTITAS MODUL</div>
                <table class="identity-table" contenteditable="true">
                    <tr><td width="180">Nama Penyusun</td><td width="10">:</td><td><span class="valGuru"></span> (<span class="valSekolah"></span>)</td></tr>
                    <tr><td>Mata Pelajaran</td><td>:</td><td><span class="valMapel"></span></td></tr>
                    <tr><td>Kelas / Fase / Smt / Rombel</td><td>:</td><td><span class="valKelasNum"></span> / <span class="valFase"></span> / <span class="valSemester"></span> / <span class="valRombel"></span></td></tr>
                    <tr><td>Topik / Bab Materi</td><td>:</td><td style="color:var(--primary);"><span class="valElemen"></span></td></tr>
                    <tr><td>Alokasi Waktu</td><td>:</td><td><span class="valJpBab"></span> JP</td></tr>
                </table>

                <div class="section-title">B. DIMENSI PROFIL LULUSAN</div>
                <div class="content-body" contenteditable="true" id="modulP3"></div>

                <div class="section-title">C. IDENTIFIKASI KESIAPAN PESERTA DIDIK</div>
                <div class="content-body" contenteditable="true">
                    <ul>
                        <li><strong>Pengetahuan Awal:</strong> Peserta didik telah memiliki pengetahuan dasar atau pengalaman terkait materi <em><span class="valElemen"></span></em> dalam kehidupan sehari-hari.</li>
                        <li><strong>Kebutuhan Belajar:</strong> Membutuhkan visualisasi gambar/video yang relevan, instruksi yang jelas, kegiatan diskusi kelompok, dan simulasi untuk memperkuat pemahaman konteks.</li>
                    </ul>
                </div>

                <div class="section-title">D. TUJUAN PEMBELAJARAN</div>
                <div class="content-body" contenteditable="true" id="modulTP"></div>

                <div class="section-title">E. LANGKAH-LANGKAH PEMBELAJARAN</div>
                <div class="content-body" contenteditable="true" id="modulLangkah"></div>

                <div class="section-title">F. ASESMEN PEMBELAJARAN</div>
                <div class="content-body" contenteditable="true">
                    <ul>
                        <li><strong>Diagnostik:</strong> Melakukan tanya jawab pemantik terkait pemahaman dan pengalaman peserta didik terhadap materi di awal pertemuan.</li>
                        <li><strong>Formatif:</strong> Observasi keterlibatan, kerjasama kelompok, dan pengerjaan Lembar Kerja Peserta Didik (LKPD) selama proses KBM berlangsung.</li>
                        <li><strong>Sumatif:</strong> Penugasan produk/proyek (unjuk kerja) dan tes tertulis di akhir bab untuk mengukur capaian kognitif.</li>
                    </ul>
                </div>
                
                <div class="signature-area" contenteditable="true">
                    <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name valKepsek"></div>NIP. <span class="valNipKepsek"></span></div>
                    <div class="signature-box right"><span class="valTempatTgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name valGuru"></div>NIP. <span class="valNipGuru"></span></div>
                </div>
            </div>

            <div class="page portrait" id="pageKktp">
                <div class="header-title" contenteditable="true" style="margin-bottom:20px;">KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN</div>
                
                <table class="identity-table" contenteditable="true" style="width: 80%; margin-bottom:20px;">
                    <tr><td width="180">PENYUSUN</td><td width="10">:</td><td><span class="valGuru"></span></td></tr>
                    <tr><td>SATUAN PENDIDIKAN</td><td>:</td><td><span class="valSekolah"></span></td></tr>
                    <tr><td>TAHUN PELAJARAN</td><td>:</td><td><span class="valTahun"></span></td></tr>
                    <tr><td>MATA PELAJARAN</td><td>:</td><td><span class="valMapel"></span></td></tr>
                    <tr><td>FASE / KELAS / ROMBEL</td><td>:</td><td><span class="valFaseHuruf"></span> / <span class="valKelasNum"></span> / <span class="valRombel"></span></td></tr>
                </table>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th rowspan="2" width="5%">No</th>
                            <th rowspan="2" width="10%">Semester</th>
                            <th rowspan="2" width="10%">Bab</th>
                            <th rowspan="2" width="45%">Capaian Pembelajaran (TP)</th>
                            <th colspan="3">Kriteria Penentuan KKTP</th>
                            <th rowspan="2" width="8%">KKTP</th>
                        </tr>
                        <tr>
                            <th width="8%" style="font-size:8pt;">Kompleksitas</th>
                            <th width="8%" style="font-size:8pt;">Daya Dukung</th>
                            <th width="8%" style="font-size:8pt;">Intaks Siswa</th>
                        </tr>
                    </thead>
                    <tbody id="bodyKktp">
                        <tr><td colspan="8">Mempersiapkan data...</td></tr>
                    </tbody>
                </table>
                
                <div class="signature-area" contenteditable="true">
                    <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name valKepsek"></div>NIP. <span class="valNipKepsek"></span></div>
                    <div class="signature-box right"><span class="valTempatTgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name valGuru"></div>NIP. <span class="valNipGuru"></span></div>
                </div>
            </div>

            <div class="page portrait" id="pageLkpd">
                <div class="lkpd-box">
                    <div class="lkpd-header" contenteditable="true">‚ú® LEMBAR KERJA PESERTA DIDIK (LKPD) ‚ú®<br><span style="font-size:12pt; color:#475569;" class="valMapel"></span></div>
                    
                    <div class="lkpd-identity" contenteditable="true">
                        <div>Nama / Kelompok : </div>
                        <div>Kelas / Rombel : <span class="valKelasNum"></span> / <span class="valRombel"></span></div>
                        <div>Nilai : </div>
                    </div>

                    <div class="content-body" contenteditable="true">
                        <p style="font-weight:bold; color:var(--primary); font-size:12pt;">A. Apa yang akan kita pelajari hari ini?</p>
                        <ul id="lkpdTP" style="margin-bottom:15px; background:#fff; padding:10px 10px 10px 30px; border-radius:6px; border:1px solid #cbd5e1;"></ul>
                        
                        <p style="font-weight:bold; color:var(--primary); font-size:12pt;">B. Petunjuk Kegiatan:</p>
                        <ol style="margin-bottom:15px;">
                            <li>Berdoa sebelum memulai kegiatan pembelajaran.</li>
                            <li>Baca setiap instruksi/pertanyaan dengan teliti dan diskusikan bersama teman kelompokmu.</li>
                            <li>Tulis jawabanmu dengan rapi. Bertanyalah kepada guru jika ada hal yang kurang jelas!</li>
                        </ol>

                        <p style="font-weight:bold; color:var(--primary); font-size:12pt;">C. Ayo Selesaikan Tantangan Ini!</p>
                        <p>Berdasarkan pemahamanmu tentang materi <strong><span class="valElemen"></span></strong>, kerjakan tugas di bawah ini!</p>
                        
                        <div style="margin-top:15px; border:2px solid #94a3b8; padding:20px; min-height: 280px; background-color:white; border-radius:10px;">
                            <p style="font-weight:bold;">1. Jelaskan pemahaman utamamu mengenai materi ini menggunakan bahasamu sendiri!</p>
                            <br><br><br><hr style="border-top:2px dashed #e2e8f0;"><br>
                            
                            <p style="font-weight:bold;">2. Berikan contoh penerapan nyata materi ini di sekolah atau lingkungan sekitarmu!</p>
                            <br><br><br><hr style="border-top:2px dashed #e2e8f0;"><br>
                            
                            <p style="font-weight:bold;">3. Apa kesimpulan atau nilai positif yang bisa kita ambil dari pembelajaran hari ini?</p>
                        </div>

                        <div style="text-align:right; margin-top:30px; font-weight:bold; color:#059669; font-size:14pt;">
                            "Semangat Belajar, Sukses Menanti!" üåü
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let kurikulumData = {}; 
        const namaBulanGanjil = ["Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const namaBulanGenap = ["Januari", "Februari", "Maret", "April", "Mei", "Juni"];
        
        // Default URL dari user (Dengan Publikasi CSV yang divalidasi)
        const defaultGoogleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv";

        function openModal() { document.getElementById('modalPanduan').style.display = 'flex'; }
        function closeModal() { document.getElementById('modalPanduan').style.display = 'none'; }

        // ==========================================
        // FITUR CLOUD & LOCAL STORAGE
        // ==========================================
        window.addEventListener('DOMContentLoaded', (event) => {
            let savedUrl = localStorage.getItem('csvCloudUrl');
            if (savedUrl) {
                document.getElementById('inputUrlCsv').value = savedUrl;
                fetchCSVFromUrl(savedUrl);
            } else {
                // Gunakan default link
                document.getElementById('inputUrlCsv').value = defaultGoogleSheetUrl;
                fetchCSVFromUrl(defaultGoogleSheetUrl);
            }
        });

        function fetchAndSaveCSV() {
            let url = document.getElementById('inputUrlCsv').value.trim();
            if (!url) {
                tampilkanStatus("‚ö†Ô∏è Link URL kosong!", true);
                return;
            }
            localStorage.setItem('csvCloudUrl', url);
            fetchCSVFromUrl(url);
        }

        function hapusUrlCSV() {
            localStorage.removeItem('csvCloudUrl');
            document.getElementById('inputUrlCsv').value = "";
            tampilkanStatus("üóëÔ∏è Link berhasil dihapus dari sistem.", false);
            kurikulumData = {}; // Clear data
            updateMateriList();
            generateSemua();
        }

        async function fetchCSVFromUrl(originalUrl) {
            tampilkanStatus("‚è≥ Mengunduh data dari Google Sheets...", false);
            try {
                // Menggunakan CORS Proxy gratis (allorigins.win) untuk bypass blokir origin 'null'
                const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(originalUrl);
                const response = await fetch(proxyUrl);
                
                if (!response.ok) throw new Error("Gagal mengambil data dari server.");
                
                const csvText = await response.text();
                prosesDataCSV(csvText);
            } catch (error) {
                tampilkanStatus("‚ùå Error: " + error.message + " Pastikan link valid dan di-publish ke web.", true);
            }
        }

        function tampilkanStatus(pesan, isError) {
            let statusEl = document.getElementById('csvStatus');
            statusEl.style.display = 'block';
            statusEl.className = isError ? 'csv-info error' : 'csv-info';
            statusEl.innerHTML = pesan;
        }

        // ==========================================
        // PARSING FILE MANUAL (JIKA USER TETAP MAU UPLOAD)
        // ==========================================
        document.getElementById('fileCsv').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { 
                tampilkanStatus("üìÑ Memproses file lokal...", false);
                prosesDataCSV(e.target.result); 
            };
            reader.readAsText(file);
        });

        // ==========================================
        // PROSES DATA CSV (INTI APLIKASI)
        // ==========================================
        function prosesDataCSV(csvText) {
            const baris = csvText.split('\n');
            kurikulumData = {}; 
            let countTp = 0;

            for(let i = 1; i < baris.length; i++) { 
                let row = baris[i].trim();
                if(!row) continue;
                
                // Mendukung separator koma (,) standar CSV online atau titik koma (;) dari Excel lokal
                let separator = row.includes(';') ? ';' : ',';
                // Regex untuk memecah CSV yang menangani tanda kutip ganda " "
                let kolom = [];
                let match;
                const regex = new RegExp(`(\"([^\"]*)\"|[^\"${separator}]+)(?=${separator}|$)`, 'g');
                
                while (match = regex.exec(row)) {
                    kolom.push(match[2] ? match[2] : match[1]); // Jika ada kutip, ambil isinya
                }

                if(kolom.length < 5) continue; 

                let kls = kolom[1] ? kolom[1].trim() : "";
                let smt = kolom[2] ? kolom[2].trim() : "";
                let elemen = kolom[3] ? kolom[3].trim() : "";
                
                let cpText, tpText, p3Text;
                if(kolom.length >= 7) {
                    cpText = kolom[4] ? kolom[4].trim() : "";
                    tpText = kolom[5] ? kolom[5].trim() : "";
                    p3Text = kolom[6] ? kolom[6].trim() : "";
                } else {
                    cpText = "<span style='color:red;'>[Update format ke 7 kolom]</span>";
                    tpText = kolom[4] ? kolom[4].trim() : "";
                    p3Text = "Beriman Bertakwa, Mandiri";
                }

                if(!kurikulumData[kls]) kurikulumData[kls] = {};
                if(!kurikulumData[kls][smt]) kurikulumData[kls][smt] = {};
                if(!kurikulumData[kls][smt][elemen]) {
                    kurikulumData[kls][smt][elemen] = { cp: cpText, tps: [] };
                }
                
                kurikulumData[kls][smt][elemen].tps.push({ tp: tpText, p3: p3Text });
                countTp++;
            }

            tampilkanStatus(`‚úÖ Sukses! Berhasil memuat <b>${countTp}</b> data Tujuan Pembelajaran.`, false);
            
            updateMateriList();
            generateSemua();
        }

        // ==========================================
        // UI & LOGIC GENERATOR
        // ==========================================
        function getLiburBaku(tahunAwal) {
            let t1 = tahunAwal; let t2 = tahunAwal + 1;
            return [`${t1}-08-17`, `${t1}-12-25`, `${t1}-12-26`, `${t2}-01-01`, `${t2}-05-01`, `${t2}-06-01`];
        }

        function kalkulasiKKTP(element) {
            let row = element.closest('tr');
            let vals = row.querySelectorAll('.kktp-val');
            let hasilTd = row.querySelector('.kktp-hasil');
            if(vals.length === 3 && hasilTd) {
                let v1 = parseFloat(vals[0].innerText.replace(/[^0-9.]/g, '')) || 0;
                let v2 = parseFloat(vals[1].innerText.replace(/[^0-9.]/g, '')) || 0;
                let v3 = parseFloat(vals[2].innerText.replace(/[^0-9.]/g, '')) || 0;
                hasilTd.innerText = Math.round((v1 + v2 + v3) / 3);
            }
        }

        function updateMateriList() {
            let kls = document.getElementById('inputKelas').value;
            let smt = document.getElementById('inputSemester').value;
            let elemenSelect = document.getElementById('inputElemen');
            elemenSelect.innerHTML = "";

            if(kurikulumData[kls] && kurikulumData[kls][smt]) {
                let elemenList = Object.keys(kurikulumData[kls][smt]);
                elemenList.forEach(el => {
                    let opt = document.createElement('option');
                    opt.value = el; opt.text = el;
                    elemenSelect.appendChild(opt);
                });
            } else {
                elemenSelect.innerHTML = "<option value=''>- Kosong -</option>";
            }
        }

        function generateSemua() {
            let mapel = document.getElementById('inputMapel').value || "Mata Pelajaran";
            let kls = document.getElementById('inputKelas').value;
            let smt = document.getElementById('inputSemester').value;
            let rombel = document.getElementById('inputRombel').value || "-";
            let elemen = document.getElementById('inputElemen').value;
            let tahunAwal = parseInt(document.getElementById('inputTahunNum').value) || 2024;
            let jpPerTp = parseInt(document.getElementById('inputJpPertemuan').value) || 4;
            let hariTarget = parseInt(document.getElementById('inputHari').value);
            
            // Hitung Fase
            let klsInt = parseInt(kls);
            let faseHuruf = "A";
            if(klsInt <= 2) faseHuruf = "A"; else if(klsInt <= 4) faseHuruf = "B"; else if(klsInt <= 6) faseHuruf = "C";
            else if(klsInt <= 9) faseHuruf = "D"; else if(klsInt == 10) faseHuruf = "E"; else if(klsInt <= 12) faseHuruf = "F";

            let thnAjarText = `${tahunAwal} / ${tahunAwal + 1}`;

            // Sync Teks Dinamis
            document.querySelectorAll('.valMapel').forEach(e => e.innerText = mapel);
            document.querySelectorAll('.valSekolah').forEach(e => e.innerText = document.getElementById('inputSekolah').value);
            document.querySelectorAll('.valTempatTgl').forEach(e => e.innerText = document.getElementById('inputTempatTgl').value);
            document.querySelectorAll('.valGuru').forEach(e => e.innerText = document.getElementById('inputGuru').value);
            document.querySelectorAll('.valKepsek').forEach(e => e.innerText = document.getElementById('inputKepsek').value);
            document.querySelectorAll('.valNipGuru').forEach(e => e.innerText = document.getElementById('inputNipGuru').value);
            document.querySelectorAll('.valNipKepsek').forEach(e => e.innerText = document.getElementById('inputNipKepsek').value);
            document.querySelectorAll('.valKelasNum').forEach(e => e.innerText = kls);
            document.querySelectorAll('.valRombel').forEach(e => e.innerText = rombel);
            document.querySelectorAll('.valSemester').forEach(e => e.innerText = smt.toUpperCase());
            document.querySelectorAll('.valTahun').forEach(e => e.innerText = thnAjarText);
            document.querySelectorAll('.valFase').forEach(e => e.innerText = "Fase " + faseHuruf);
            document.querySelectorAll('.valFaseHuruf').forEach(e => e.innerText = faseHuruf);
            document.querySelectorAll('.valElemen').forEach(e => e.innerText = elemen || "...");

            let allBabInSmt = [];
            if(kurikulumData[kls] && kurikulumData[kls][smt]) {
                for (let babName in kurikulumData[kls][smt]) {
                    allBabInSmt.push({ bab: babName, cp: kurikulumData[kls][smt][babName].cp, tps: kurikulumData[kls][smt][babName].tps });
                }
            }

            let spesifikData = kurikulumData[kls]?.[smt]?.[elemen];
            let spesifikTP = spesifikData ? spesifikData.tps : [];
            document.querySelectorAll('.valJpBab').forEach(e => e.innerText = spesifikTP.length * jpPerTp);

            // LOGIKA HARI EFEKTIF
            let colEvents = new Array(30).fill(null);
            if (smt === "Ganjil") {
                colEvents[0] = "MPLS / Libur"; colEvents[1] = "MPLS / Libur";           
                colEvents[13] = "SUMATIF TENGAH SMT"; colEvents[25] = "SUMATIF AKHIR SMT";     
                colEvents[26] = "PENGAYAAN / CLASSMEET"; colEvents[27] = "PEMBAGIAN RAPOR";       
                colEvents[28] = "LIBUR SMT GANJIL"; colEvents[29] = "LIBUR SMT GANJIL";      
            } else {
                colEvents[0] = "LIBUR SMT GANJIL"; colEvents[11] = "SUMATIF TENGAH SMT";    
                colEvents[25] = "SUMATIF AKHIR SMT / PAT"; colEvents[26] = "PENGAYAAN / CLASSMEET"; 
                colEvents[27] = "PEMBAGIAN RAPOR"; colEvents[28] = "LIBUR SMT GENAP"; colEvents[29] = "LIBUR SMT GENAP";       
            }

            let blnAwal = (smt === "Ganjil") ? 6 : 0; 
            let rawLibur = document.getElementById("inputLibur").value.split(/[\n,]+/);
            let daftarLibur = getLiburBaku(tahunAwal);
            rawLibur.forEach(d => { let trimD = d.trim(); if(trimD) daftarLibur.push(trimD); });

            daftarLibur.forEach(dateStr => {
                let p = dateStr.split('-');
                if(p.length === 3) {
                    let y = parseInt(p[0]); let m = parseInt(p[1]) - 1; let d = parseInt(p[2]);
                    let tglLibur = new Date(y, m, d);
                    if (tglLibur.getDay() === hariTarget) {
                        let mIdx = m - blnAwal;
                        if(smt === "Ganjil" && mIdx < 0) mIdx += 12;
                        if(mIdx >= 0 && mIdx <= 5) {
                            let wIdx = Math.ceil(d / 7);
                            if(wIdx > 5) wIdx = 5;
                            let c = (mIdx * 5) + (wIdx - 1);
                            if(c >= 0 && c < 30 && colEvents[c] === null) colEvents[c] = "LIBUR NASIONAL / KHUSUS";
                        }
                    }
                }
            });

            let thnOperasional = (smt === "Ganjil") ? tahunAwal : tahunAwal + 1;
            let semuaTanggalMengajar = [];
            for (let i = 0; i < 6; i++) {
                let blnSekarang = blnAwal + i;
                let curYear = thnOperasional;
                if(smt === "Ganjil" && blnSekarang > 11) { curYear++; blnSekarang -= 12; }
                let jmlHari = new Date(curYear, blnSekarang + 1, 0).getDate();
                for (let tgl = 1; tgl <= jmlHari; tgl++) {
                    let tglObyek = new Date(curYear, blnSekarang, tgl);
                    if (tglObyek.getDay() === hariTarget) {
                        let wIdx = Math.ceil(tgl / 7);
                        if(wIdx > 5) wIdx = 5;
                        let c = (i * 5) + (wIdx - 1);
                        if(colEvents[c] === null) semuaTanggalMengajar.push(tglObyek);
                    }
                }
            }

            // ==========================================
            // RENDER DOKUMEN 
            // ==========================================
            renderATP(allBabInSmt, jpPerTp);
            let promesRows = renderProta(allBabInSmt, jpPerTp, smt, semuaTanggalMengajar);
            renderPromes(promesRows, colEvents, smt, blnAwal);
            renderKktp(allBabInSmt, smt);
            renderModulLkpd(spesifikTP, jpPerTp);
        }

        // --- Fungsi Bantuan Render Dokumen ---
        function renderATP(allBabInSmt, jpPerTp) {
            let html = "";
            if(allBabInSmt.length > 0) {
                allBabInSmt.forEach((babObj, iBab) => {
                    let totalJpBab = babObj.tps.length * jpPerTp;
                    let mgg = Math.ceil(totalJpBab / jpPerTp);
                    babObj.tps.forEach((tpObj, iTp) => {
                        let match = tpObj.tp.match(/mampu\s+([a-zA-Z\-]+)/i);
                        let kompetensi = match ? (match[1].charAt(0).toUpperCase() + match[1].slice(1)) : "Memahami";
                        html += `<tr>`;
                        if(iTp === 0) {
                            html += `<td rowspan="${babObj.tps.length}">${iBab + 1}</td>`;
                            html += `<td rowspan="${babObj.tps.length}" class="text-left" contenteditable="true"><b>${babObj.bab}</b><br><br><span style="color:#0f172a;">${babObj.cp}</span></td>`;
                            html += `<td rowspan="${babObj.tps.length}" class="text-left" contenteditable="true">Peserta didik memahami materi terkait ${babObj.bab} dengan baik.</td>`;
                        }
                        html += `<td class="text-left" contenteditable="true"><b>${iBab+1}.${iTp+1}</b> ${tpObj.tp}</td>`;
                        html += `<td contenteditable="true" style="font-size:9pt; color:#1e40af; font-weight:bold;">${tpObj.p3}</td>`;
                        html += `<td contenteditable="true" style="color:#eab308; font-weight:bold;">${kompetensi}</td>`;
                        if(iTp === 0) {
                            html += `<td rowspan="${babObj.tps.length}" contenteditable="true">${babObj.bab}</td>`;
                            html += `<td rowspan="${babObj.tps.length}" contenteditable="true"><b>${mgg} Minggu<br>${totalJpBab} JP</b></td>`;
                            html += `<td rowspan="${babObj.tps.length}" contenteditable="true"></td>`;
                        }
                        html += `</tr>`;
                    });
                });
            } else { html = `<tr><td colspan="9">Data belum dimuat/Kosong</td></tr>`; }
            document.getElementById('bodyAtp').innerHTML = html;
        }

        function renderProta(allBabInSmt, jpPerTp, smt, semuaTanggalMengajar) {
            let html = ""; let promesRows = []; let idxTanggal = 0; 
            if(allBabInSmt.length > 0) {
                allBabInSmt.forEach((babObj, iBab) => {
                    let totalJpBab = babObj.tps.length * jpPerTp;
                    babObj.tps.forEach((tpObj, iTp) => {
                        html += `<tr>`;
                        if(iTp === 0) {
                            html += `<td rowspan="${babObj.tps.length}">${smt}</td>`;
                            html += `<td rowspan="${babObj.tps.length}" style="background:#f8fafc; padding:10px;" contenteditable="true"><div class="vertical-text" style="font-weight:bold;">${babObj.bab}</div></td>`;
                        }
                        html += `<td class="text-left" contenteditable="true">${tpObj.tp}</td>`;
                        if(iTp === 0) { html += `<td rowspan="${babObj.tps.length}"><b>${totalJpBab} JP</b></td>`; }
                        html += `</tr>`;
                        let alokasiPromes = [];
                        if (idxTanggal < semuaTanggalMengajar.length) {
                            alokasiPromes.push({ date: semuaTanggalMengajar[idxTanggal], jp: jpPerTp });
                            idxTanggal++;
                        }
                        promesRows.push({ namaBab: iTp===0 ? babObj.bab : "", namaTp: tpObj.tp, totalJp: jpPerTp, alokasi: alokasiPromes, rowspan: iTp===0 ? babObj.tps.length : 0 });
                    });
                });
            } else { html = `<tr><td colspan="4">Data belum dimuat/Kosong</td></tr>`; }
            document.getElementById('bodyProta').innerHTML = html;
            return promesRows;
        }

        function renderPromes(promesRows, colEvents, smt, blnAwal) {
            let namaBulan = (smt === "Ganjil") ? namaBulanGanjil : namaBulanGenap;
            let headHtml = `<tr><th rowspan="2" width="5%">Bab / Elemen</th><th rowspan="2" width="22%">Capaian Pembelajaran (TP)</th><th rowspan="2" width="3%">JP</th>`;
            namaBulan.forEach(b => headHtml += `<th colspan="5">${b}</th>`);
            headHtml += `</tr><tr>`; for(let i=0; i<6; i++) { headHtml += `<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>`; } headHtml += `</tr>`;
            document.getElementById("headPromes").innerHTML = headHtml;

            let bodyHtml = ""; let tRows = promesRows.length || 1;
            if(promesRows.length > 0) {
                promesRows.forEach((row, r) => {
                    bodyHtml += `<tr>`;
                    if(row.rowspan > 0) { bodyHtml += `<td rowspan="${row.rowspan}" style="background:#f8fafc; padding:10px;" contenteditable="true"><div class="vertical-text" style="font-weight:bold; font-size:9pt;">${row.namaBab}</div></td>`; }
                    bodyHtml += `<td class="text-left" contenteditable="true">${row.namaTp}</td><td>${row.totalJp}</td>`;
                    for (let c = 0; c < 30; c++) {
                        if (colEvents[c] !== null) {
                            if (r === 0) { bodyHtml += `<td rowspan="${tRows}" style="background-color: #f1f5f9; padding:5px;" contenteditable="true"><div class="vertical-event">${colEvents[c]}</div></td>`; }
                        } else {
                            let mIdx = Math.floor(c / 5); let wIdx = (c % 5) + 1;
                            let bulanTarget = blnAwal + mIdx; if(bulanTarget > 11) bulanTarget -= 12;
                            let alokasiSelIni = row.alokasi.filter(a => {
                                let aMonth = a.date.getMonth(); let aWeek = Math.ceil(a.date.getDate() / 7);
                                if(aWeek > 5) aWeek = 5; return (aMonth === bulanTarget) && (aWeek === wIdx);
                            });
                            if(alokasiSelIni.length > 0) {
                                let totalJpSel = alokasiSelIni.reduce((sum, a) => sum + a.jp, 0);
                                let labelTgl = alokasiSelIni.map(a => a.date.getDate()).join(',');
                                bodyHtml += `<td style="background-color:#dbeafe;" contenteditable="true"><span class="cell-jp">${totalJpSel}</span><span class="cell-date">${labelTgl}</span></td>`;
                            } else { bodyHtml += `<td contenteditable="true"></td>`; }
                        }
                    }
                    bodyHtml += `</tr>`;
                });
            } else { bodyHtml = `<tr><td colspan="33">Data Kosong</td></tr>`; }
            document.getElementById("bodyPromes").innerHTML = bodyHtml;
        }

        function renderKktp(allBabInSmt, smt) {
            let html = "";
            if(allBabInSmt.length > 0) {
                allBabInSmt.forEach((babObj, iBab) => {
                    babObj.tps.forEach((tpObj, iTp) => {
                        html += `<tr>`;
                        if(iTp === 0) {
                            html += `<td rowspan="${babObj.tps.length}">${iBab + 1}</td>`;
                            html += `<td rowspan="${babObj.tps.length}">${smt}</td>`;
                            html += `<td rowspan="${babObj.tps.length}" style="background:#f8fafc; padding:10px;"><div class="vertical-text" style="font-weight:bold; font-size:9.5pt;">${babObj.bab}</div></td>`;
                        }
                        html += `<td class="text-left" contenteditable="true">${tpObj.tp}</td>`;
                        html += `<td class="kktp-val" contenteditable="true" oninput="kalkulasiKKTP(this)">75</td>`;
                        html += `<td class="kktp-val" contenteditable="true" oninput="kalkulasiKKTP(this)">75</td>`;
                        html += `<td class="kktp-val" contenteditable="true" oninput="kalkulasiKKTP(this)">75</td>`;
                        html += `<td class="kktp-hasil" style="font-weight:bold;">75</td>`;
                        html += `</tr>`;
                    });
                });
            } else { html = `<tr><td colspan="8">Data Kosong</td></tr>`; }
            document.getElementById('bodyKktp').innerHTML = html;
        }

        function renderModulLkpd(spesifikTP, jpPerTp) {
            let p3HTML = "<ul>"; let p3Array = [];
            spesifikTP.forEach(item => {
                let parts = item.p3.split(',');
                parts.forEach(p => { let cln = p.trim(); if(cln && !p3Array.includes(cln)) p3Array.push(cln); });
            });
            p3Array.forEach(p => { p3HTML += `<li><strong>${p}</strong></li>`; });
            document.getElementById('modulP3').innerHTML = p3Array.length ? p3HTML + "</ul>" : "<p>Dimensi Profil Lulusan tidak ditemukan.</p>";

            let tpModul = "<ul>"; let langkahModul = ""; let tpLkpd = "";
            spesifikTP.forEach((tpObj, i) => {
                let pert = i + 1;
                tpModul += `<li><span style="font-weight:bold;">Pertemuan ${pert}:</span> ${tpObj.tp}</li>`;
                tpLkpd += `<li>${tpObj.tp}</li>`;
                langkahModul += `
                <div style="margin-bottom: 15px;">
                    <div style="background-color: #f1f5f9; padding: 6px; font-weight: bold; border-left: 3px solid var(--secondary);">Pertemuan ${pert} (${jpPerTp} JP)</div>
                    <ul style="margin-top: 5px;">
                        <li><strong>Pendahuluan (Mindful):</strong> Guru membuka dengan doa, menanyakan kabar, lalu memancing rasa ingin tahu melalui pertanyaan pemantik.</li>
                        <li><strong>Kegiatan Inti (Meaningful & Joyful):</strong> Siswa berdiskusi, mengerjakan LKPD secara kelompok, dan mempresentasikan karyanya secara interaktif.</li>
                        <li><strong>Penutup:</strong> Guru memberikan penguatan materi, refleksi, diakhiri doa bersama.</li>
                    </ul>
                </div>`;
            });
            document.getElementById('modulTP').innerHTML = spesifikTP.length ? tpModul + "</ul>" : "<p>Data TP belum tersedia.</p>";
            document.getElementById('modulLangkah').innerHTML = spesifikTP.length ? langkahModul : "<p>Langkah pembelajaran kosong.</p>";
            document.getElementById('lkpdTP').innerHTML = spesifikTP.length ? tpLkpd : "<li>Tujuan Pembelajaran</li>";
        }
    </script>
</body>
</html>